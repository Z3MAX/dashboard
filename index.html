<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Cart√£o Corporativo - Technology</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            position: relative;
        }

        /* Chat Widget Styles */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            transform: translateY(100%);
            opacity: 0;
        }

        .chat-widget.open {
            transform: translateY(0);
            opacity: 1;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-header p {
            margin: 5px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .chat-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .chat-close:hover {
            background: rgba(255,255,255,0.1);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-message.user .message-content {
            background: #667eea;
            color: white;
            margin-left: 20px;
            margin-right: 0;
        }

        .chat-message.assistant .message-content {
            background: white;
            color: #333;
            margin-right: 20px;
            border: 1px solid #e0e0e0;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background: #667eea;
            color: white;
        }

        .message-avatar.assistant {
            background: #f0f0f0;
            color: #666;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .chat-send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-send-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }

        .chat-toggle.hidden {
            display: none;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 12px 16px;
            background: white;
            border-radius: 15px;
            margin-right: 20px;
            border: 1px solid #e0e0e0;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .suggested-questions {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .suggested-questions h4 {
            margin: 0 0 10px 0;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-chip {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-chip:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .chat-widget {
                width: calc(100vw - 40px);
                height: calc(100vh - 100px);
                bottom: 10px;
                right: 20px;
                left: 20px;
            }
            
            .chat-toggle {
                bottom: 10px;
                right: 10px;
            }
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .filter-container {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .filter-select {
            padding: 8px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .filter-select:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }
        
        .month-tabs {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        
        .month-tab {
            padding: 8px 20px;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #7f8c8d;
            transition: all 0.3s ease;
        }
        
        .month-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .month-tab:hover:not(.active) {
            background: #f8f9fa;
            border-color: #667eea;
            color: #667eea;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .services-section {
            padding: 30px;
        }
        
        .services-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .services-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .service-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .service-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .service-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .service-count {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .service-value {
            font-size: 14px;
            font-weight: 600;
            color: #27ae60;
            margin-top: 5px;
        }
        
        .table-section {
            padding: 30px;
        }
        
        .table-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .table-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
        }
        
        .data {
            white-space: nowrap;
            font-family: monospace;
            font-size: 12px;
        }
        
        .movimentacao {
            max-width: 180px;
            word-wrap: break-word;
            font-size: 12px;
        }
        
        .valor-usd {
            text-align: right;
            font-weight: 600;
            color: #2e7d32;
            font-size: 12px;
        }
        
        .valor-brl {
            text-align: right;
            font-weight: 600;
            color: #1565c0;
            font-size: 12px;
        }
        
        .month-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            margin-right: 8px;
        }
        
        .month-maio { background: #e74c3c; }
        .month-junho { background: #f39c12; }
        .month-julho { background: #27ae60; }
        
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .month-tabs {
                margin-left: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üìä Dashboard Cart√£o Corporativo</h1>
            <p>Technology Department | Jorge Jamil | Maio - Julho 2025</p>
        </div>

        <div class="filter-section">
            <div class="filter-container">
                <div class="filter-group">
                    <label for="categoryFilter">Filtrar por Categoria:</label>
                    <select id="categoryFilter" class="filter-select">
                        <option value="all">Todas as Categorias</option>
                        <option value="IA">IA</option>
                        <option value="Desenvolvimento">Desenvolvimento</option>
                        <option value="Cloud">Cloud</option>
                        <option value="Educa√ß√£o">Educa√ß√£o</option>
                        <option value="Hardware">Hardware</option>
                        <option value="Dom√≠nios">Dom√≠nios</option>
                        <option value="E-commerce">E-commerce</option>
                        <option value="Ferramentas">Ferramentas</option>
                        <option value="Telefonia">Telefonia</option>
                        <option value="Colabora√ß√£o">Colabora√ß√£o</option>
                        <option value="Automa√ß√£o">Automa√ß√£o</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                
                <div class="month-tabs">
                    <div class="month-tab active" data-month="all">Todos os Meses</div>
                    <div class="month-tab" data-month="maio">Maio</div>
                    <div class="month-tab" data-month="junho">Junho</div>
                    <div class="month-tab" data-month="julho">Julho</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí≥</div>
                <div class="stat-value" id="totalTransactions">0</div>
                <div class="stat-label">Transa√ß√µes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="totalBRL">R$ 0</div>
                <div class="stat-label">Total Gasto (BRL)</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíµ</div>
                <div class="stat-value" id="totalUSD">$ 0</div>
                <div class="stat-label">Total Gasto (USD)</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-value" id="avgTransaction">R$ 0</div>
                <div class="stat-label">M√©dia por Transa√ß√£o</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ü§ñ</div>
                <div class="stat-value" id="aiPercentage">0%</div>
                <div class="stat-label">Gastos com IA</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value" id="activeDays">0</div>
                <div class="stat-label">Dias de Atividade</div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card">
                <h3>üìä Gastos por Categoria</h3>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>üìà Evolu√ß√£o Mensal dos Gastos</h3>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <div class="services-section">
            <div class="services-card">
                <h3>üèÜ Top 10 Servi√ßos Mais Utilizados</h3>
                <div class="services-grid" id="servicesGrid">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-card">
                <h3>üìã Hist√≥rico Completo de Transa√ß√µes</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>M√™s</th>
                                <th>Data</th>
                                <th>Servi√ßo</th>
                                <th>USD</th>
                                <th>BRL</th>
                                <th>Categoria</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <!-- Ser√° preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget" id="chatWidget">
        <div class="chat-header">
            <h3>ü§ñ AI Assistant</h3>
            <p>Pergunte sobre seus dados financeiros</p>
            <button class="chat-close" onclick="toggleChat()">√ó</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
                <div class="message-avatar assistant">ü§ñ</div>
                <div class="message-content">
                    Ol√°! Sou seu assistente de IA. Posso te ajudar a analisar seus dados financeiros. Que tipo de informa√ß√£o voc√™ gostaria de saber?
                </div>
            </div>
        </div>
        
        <div class="suggested-questions">
            <h4>Perguntas Sugeridas:</h4>
            <div class="suggestion-chips">
                <div class="suggestion-chip" onclick="sendSuggestedQuestion('Qual foi o maior gasto do m√™s?')">Maior gasto do m√™s</div>
                <div class="suggestion-chip" onclick="sendSuggestedQuestion('Quanto gastei com IA?')">Gastos com IA</div>
                <div class="suggestion-chip" onclick="sendSuggestedQuestion('Qual categoria mais cara?')">Categoria mais cara</div>
                <div class="suggestion-chip" onclick="sendSuggestedQuestion('Analise meus padr√µes de gastos')">Padr√µes de gastos</div>
                <div class="suggestion-chip" onclick="sendSuggestedQuestion('Como economizar?')">Como economizar</div>
            </div>
        </div>
        
        <div class="api-key-section" id="apiKeySection">
            <div style="padding: 15px; background: #e8f5e8; border: 1px solid #c3e6c3; border-radius: 8px; margin: 10px 20px;">
                <h5 style="margin: 0 0 10px 0; color: #2d5a2d;">üöÄ Configura√ß√£o Netlify + Gemini AI</h5>
                <p style="margin: 0 0 10px 0; font-size: 12px; color: #2d5a2d;">
                    <strong>Op√ß√£o 1:</strong> Configurar via vari√°veis de ambiente (Recomendado)
                </p>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <p style="margin: 0 0 5px 0; font-size: 11px; color: #666;">
                        <strong>1.</strong> Netlify Dashboard ‚Üí Site Settings ‚Üí Environment Variables
                    </p>
                    <p style="margin: 0 0 5px 0; font-size: 11px; color: #666;">
                        <strong>2.</strong> Adicionar: <code>GEMINI_API_KEY = sua-chave-aqui</code>
                    </p>
                    <p style="margin: 0; font-size: 11px; color: #666;">
                        <strong>3.</strong> Redeploy do site
                    </p>
                </div>
                
                <p style="margin: 10px 0 5px 0; font-size: 12px; color: #2d5a2d;">
                    <strong>Op√ß√£o 2:</strong> Inserir manualmente (menos seguro)
                </p>
                <div style="display: flex; gap: 10px;">
                    <input type="password" id="apiKeyInput" placeholder="Sua chave da API do Gemini" 
                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    <button onclick="saveApiKey()" style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        Salvar
                    </button>
                </div>
                
                <p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">
                    <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: #667eea;">
                        Obter chave da API gratuita ‚Üí
                    </a>
                </p>
            </div>
        </div>
        
        <div class="chat-input-container">
            <form class="chat-input-form" onsubmit="sendMessage(event)">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Digite sua pergunta..."
                    autocomplete="off"
                >
                <button type="submit" class="chat-send-btn" id="chatSendBtn">
                    <span>üì§</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Chat Toggle Button -->
    <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">
        üí¨
    </button>

    <script>
        // Dados das transa√ß√µes consolidadas
        const allTransactions = [
            // MAIO 2025
            { month: 'maio', date: '07.04.2025', service: 'MERCADOLIVRE*MASTE01/02', usd: '-', brl: 'R$ 174,99', category: 'E-commerce' },
            { month: 'maio', date: '07.04.2025', service: 'MERCADOLIVRE*CEREASHOPP', usd: '-', brl: 'R$ 205,00', category: 'E-commerce' },
            { month: 'maio', date: '07.04.2025', service: 'OPENAI - USD100', usd: '$100,00', brl: 'R$ 624,00', category: 'IA' },
            { month: 'maio', date: '09.04.2025', service: 'MERCADOLIVRE*MERCADOLIV', usd: '-', brl: 'R$ 518,00', category: 'E-commerce' },
            { month: 'maio', date: '10.04.2025', service: 'MIRO.COM - USD110', usd: '$110,00', brl: 'R$ 689,70', category: 'Colabora√ß√£o' },
            { month: 'maio', date: '14.04.2025', service: 'MERCADOLIVRE*MERCADOLIV', usd: '-', brl: 'R$ 259,00', category: 'E-commerce' },
            { month: 'maio', date: '14.04.2025', service: 'HUB*KABUM', usd: '-', brl: 'R$ 7.345,56', category: 'Hardware' },
            { month: 'maio', date: '15.04.2025', service: 'WL *VUE*TESTING EXAM - USD59', usd: '$59,00', brl: 'R$ 367,57', category: 'Educa√ß√£o' },
            { month: 'maio', date: '16.04.2025', service: 'DIDWW - USD50', usd: '$50,00', brl: 'R$ 311,00', category: 'Telefonia' },
            { month: 'maio', date: '18.04.2025', service: 'DIDWW - USD50', usd: '$50,00', brl: 'R$ 310,50', category: 'Telefonia' },
            { month: 'maio', date: '19.04.2025', service: 'HARVARD HKS EXEC ED - USD11200', usd: '$11.200,00', brl: 'R$ 69.552,00', category: 'Educa√ß√£o' },
            { month: 'maio', date: '21.04.2025', service: 'ONLYDOMAINS.COM - USD76.29', usd: '$76,29', brl: 'R$ 473,76', category: 'Dom√≠nios' },
            { month: 'maio', date: '21.04.2025', service: 'ONLYDOMAINS.COM - USD78.29', usd: '$78,29', brl: 'R$ 486,18', category: 'Dom√≠nios' },
            { month: 'maio', date: '21.04.2025', service: 'ONLYDOMAINS.COM - USD19.29', usd: '$19,29', brl: 'R$ 119,79', category: 'Dom√≠nios' },
            { month: 'maio', date: '22.04.2025', service: 'ONLYDOMAINS.COM - USD17.99', usd: '$17,99', brl: 'R$ 109,56', category: 'Dom√≠nios' },
            { month: 'maio', date: '22.04.2025', service: 'ONLYDOMAINS.COM - USD36.49', usd: '$36,49', brl: 'R$ 222,22', category: 'Dom√≠nios' },
            { month: 'maio', date: '22.04.2025', service: 'ONLYDOMAINS.COM - USD39.99', usd: '$39,99', brl: 'R$ 243,54', category: 'Dom√≠nios' },
            { month: 'maio', date: '22.04.2025', service: 'ONLYDOMAINS.COM - USD12.49', usd: '$12,49', brl: 'R$ 76,06', category: 'Dom√≠nios' },
            { month: 'maio', date: '24.04.2025', service: 'ONLYDOMAINS.COM - USD38.49', usd: '$38,49', brl: 'R$ 231,32', category: 'Dom√≠nios' },
            { month: 'maio', date: '25.04.2025', service: 'MERCADOLIVRE*CEREASHOPP', usd: '-', brl: 'R$ 192,00', category: 'E-commerce' },
            { month: 'maio', date: '25.04.2025', service: 'MERCADOLIVRE*CEREASHOP', usd: '-', brl: 'R$ 192,00', category: 'E-commerce' },
            { month: 'maio', date: '26.04.2025', service: 'PPRO*MICROSOFT', usd: '-', brl: 'R$ 136,90', category: 'Cloud' },
            { month: 'maio', date: '28.04.2025', service: 'MERCADOLIVRE*TECHCYCLES', usd: '-', brl: 'R$ 388,30', category: 'E-commerce' },
            { month: 'maio', date: '30.04.2025', service: 'OPENAI *CHATGPT SUBSCR - USD60', usd: '$60,00', brl: 'R$ 360,00', category: 'IA' },
            { month: 'maio', date: '30.04.2025', service: 'OPENAI *CHATGPT SUBSCR - USD120', usd: '$120,00', brl: 'R$ 720,00', category: 'IA' },
            { month: 'maio', date: '02.05.2025', service: 'AWS BRAZIL', usd: '-', brl: 'R$ 483,60', category: 'Cloud' },
            { month: 'maio', date: '03.05.2025', service: 'MSFT * E0500W566X', usd: '-', brl: 'R$ 535,50', category: 'Cloud' },
            { month: 'maio', date: '03.05.2025', service: 'MSFT * E0500W566W', usd: '-', brl: 'R$ 1.190,10', category: 'Cloud' },
            { month: 'maio', date: '04.05.2025', service: 'PPRO   *MICROSOFT', usd: '-', brl: 'R$ 119,00', category: 'Cloud' },
            { month: 'maio', date: '03.05.2025', service: 'ONLYDOMAINS.COM - USD239.98', usd: '$239,98', brl: 'R$ 1.432,68', category: 'Dom√≠nios' },
            { month: 'maio', date: '04.05.2025', service: 'ONLYDOMAINS.COM - USD24.99', usd: '$24,99', brl: 'R$ 149,19', category: 'Dom√≠nios' },
            { month: 'maio', date: '04.05.2025', service: 'DIDWW - USD50', usd: '$50,00', brl: 'R$ 298,50', category: 'Telefonia' },
            { month: 'maio', date: '05.05.2025', service: 'MERCADOLIVRE*CEREASHOPP', usd: '-', brl: 'R$ 188,00', category: 'E-commerce' },
            { month: 'maio', date: '05.05.2025', service: 'MAGALUPAY*KABUM   01/03', usd: '-', brl: 'R$ 517,41', category: 'Hardware' },

            // JUNHO 2025
            { month: 'junho', date: '06.05.2025', service: 'REGISTROBR 44180607', usd: '-', brl: 'R$ 112,00', category: 'Dom√≠nios' },
            { month: 'junho', date: '07.05.2025', service: 'ONLYDOMAINS.COM', usd: '$50,49', brl: 'R$ 306,98', category: 'Dom√≠nios' },
            { month: 'junho', date: '09.05.2025', service: 'WL *VUE*TESTING EXAM', usd: '$59,00', brl: 'R$ 352,82', category: 'Educa√ß√£o' },
            { month: 'junho', date: '10.05.2025', service: 'MIRO.COM', usd: '$129,94', brl: 'R$ 777,04', category: 'Colabora√ß√£o' },
            { month: 'junho', date: '12.05.2025', service: 'MERCADOLIVRE*CASHF01/02', usd: '-', brl: 'R$ 1.818,81', category: 'E-commerce' },
            { month: 'junho', date: '12.05.2025', service: 'MERCADOLIVRE*DOGEL01/02', usd: '-', brl: 'R$ 522,95', category: 'E-commerce' },
            { month: 'junho', date: '14.05.2025', service: 'MERCADOLIVRE*EBAZARCOMB', usd: '-', brl: 'R$ 509,70', category: 'E-commerce' },
            { month: 'junho', date: '14.05.2025', service: 'MERCADOLIVRE*TDHARMARIN', usd: '-', brl: 'R$ 413,00', category: 'E-commerce' },
            { month: 'junho', date: '15.05.2025', service: 'MERCADOLIVRE*PROSPERITY', usd: '-', brl: 'R$ 199,00', category: 'E-commerce' },
            { month: 'junho', date: '15.05.2025', service: 'MERCADOLIVRE*PROSPERITY', usd: '-', brl: 'R$ 260,00', category: 'E-commerce' },
            { month: 'junho', date: '15.05.2025', service: 'MERCADOLIVRE*2PRODUTOS', usd: '-', brl: 'R$ 903,09', category: 'E-commerce' },
            { month: 'junho', date: '16.05.2025', service: 'DIDWW', usd: '$50,00', brl: 'R$ 302,00', category: 'Telefonia' },
            { month: 'junho', date: '18.05.2025', service: 'DIDWW', usd: '$50,00', brl: 'R$ 302,00', category: 'Telefonia' },
            { month: 'junho', date: '21.05.2025', service: 'MERCADOLIVRE*18PRO01/02', usd: '-', brl: 'R$ 908,20', category: 'E-commerce' },
            { month: 'junho', date: '21.05.2025', service: 'MERCADOLIVRE*18PRO01/02', usd: '-', brl: 'R$ 703,90', category: 'E-commerce' },
            { month: 'junho', date: '21.05.2025', service: 'MERLIN', usd: '$190,00', brl: 'R$ 1.136,20', category: 'IA' },
            { month: 'junho', date: '22.05.2025', service: 'BOLT (BY STACKBLITZ)', usd: '$240,00', brl: 'R$ 1.437,60', category: 'Desenvolvimento' },
            { month: 'junho', date: '22.05.2025', service: 'WWW.PERPLEXITY.AI', usd: '$20,00', brl: 'R$ 119,80', category: 'IA' },
            { month: 'junho', date: '22.05.2025', service: 'WWW.PERPLEXITY.AI', usd: '$40,00', brl: 'R$ 239,60', category: 'IA' },
            { month: 'junho', date: '24.05.2025', service: 'BLACK HAT* BLACK HAT U', usd: '$1.339,00', brl: 'R$ 8.074,17', category: 'Educa√ß√£o' },
            { month: 'junho', date: '26.05.2025', service: 'MICROSOFT-G093799295', usd: '-', brl: 'R$ 136,90', category: 'Cloud' },
            { month: 'junho', date: '26.05.2025', service: 'PADDLE.NET* N8N CLOUD1', usd: 'BRL375,00', brl: 'R$ 398,76', category: 'Automa√ß√£o' },
            { month: 'junho', date: '27.05.2025', service: 'OPENAI *CHATGPT SUBSCR', usd: '$10,07', brl: 'R$ 60,32', category: 'IA' },
            { month: 'junho', date: '28.05.2025', service: 'MAGALUPAY*KABUM', usd: '-', brl: 'R$ 3.415,35', category: 'Hardware' },
            { month: 'junho', date: '28.05.2025', service: 'MERCADOLIVRE*EBAZARCOM', usd: '-', brl: 'R$ 557,00', category: 'E-commerce' },
            { month: 'junho', date: '28.05.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL825,00', brl: 'R$ 882,85', category: 'IA' },
            { month: 'junho', date: '28.05.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL164,85', brl: 'R$ 176,44', category: 'IA' },
            { month: 'junho', date: '28.05.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL164,85', brl: 'R$ 176,44', category: 'IA' },
            { month: 'junho', date: '28.05.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL163,57', brl: 'R$ 175,05', category: 'IA' },
            { month: 'junho', date: '29.05.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL159,68', brl: 'R$ 169,70', category: 'IA' },
            { month: 'junho', date: '29.05.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL159,68', brl: 'R$ 169,70', category: 'IA' },
            { month: 'junho', date: '30.05.2025', service: 'OPENAI *CHATGPT SUBSCR', usd: '$120,00', brl: 'R$ 729,60', category: 'IA' },
            { month: 'junho', date: '31.05.2025', service: 'OPENAI *CHATGPT SUBSCR', usd: '$120,00', brl: 'R$ 729,60', category: 'IA' },
            { month: 'junho', date: '01.06.2025', service: 'AWS BRAZIL', usd: '-', brl: 'R$ 7,16', category: 'Cloud' },
            { month: 'junho', date: '02.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL137,28', brl: 'R$ 146,29', category: 'IA' },
            { month: 'junho', date: '02.06.2025', service: 'ANTHROPIC', usd: '$5,00', brl: 'R$ 30,15', category: 'IA' },
            { month: 'junho', date: '02.06.2025', service: 'OPENAI', usd: '$100,00', brl: 'R$ 603,00', category: 'IA' },
            { month: 'junho', date: '03.06.2025', service: 'MERCADOLIVRE*NEXUSONLIN', usd: '-', brl: 'R$ 869,00', category: 'E-commerce' },
            { month: 'junho', date: '03.06.2025', service: 'MSFT * E0500WG1F9', usd: '-', brl: 'R$ 535,50', category: 'Cloud' },
            { month: 'junho', date: '03.06.2025', service: 'MSFT * E0500WG1KZ', usd: '-', brl: 'R$ 119,00', category: 'Cloud' },
            { month: 'junho', date: '03.06.2025', service: 'MSFT * E0500WFXHS', usd: '-', brl: 'R$ 1.190,10', category: 'Cloud' },
            { month: 'junho', date: '04.06.2025', service: 'MERCADOLIVRE*MERCA01/02', usd: '-', brl: 'R$ 375,00', category: 'E-commerce' },
            { month: 'junho', date: '04.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL126,12', brl: 'R$ 133,62', category: 'IA' },
            { month: 'junho', date: '04.06.2025', service: 'SUPABASE', usd: '$25,00', brl: 'R$ 149,00', category: 'Cloud' },
            { month: 'junho', date: '04.06.2025', service: 'DIDWW', usd: '$50,00', brl: 'R$ 298,00', category: 'Telefonia' },

            // JULHO 2025
            { month: 'julho', date: '05.06.2025', service: 'BOLT (BY STACKBLITZ)', usd: '$330,53', brl: 'R$ 1.956,74', category: 'Desenvolvimento' },
            { month: 'julho', date: '05.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL121,76', brl: 'R$ 128,52', category: 'IA' },
            { month: 'julho', date: '05.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL120,66', brl: 'R$ 127,40', category: 'IA' },
            { month: 'julho', date: '05.06.2025', service: 'CHECKR, INC CHECKR.COM', usd: '$166,44', brl: 'R$ 985,32', category: 'Ferramentas' },
            { month: 'julho', date: '05.06.2025', service: 'ABACUS.AI', usd: '$10,00', brl: 'R$ 59,20', category: 'IA' },
            { month: 'julho', date: '05.06.2025', service: 'ABACUS.AI', usd: '$20,00', brl: 'R$ 118,40', category: 'IA' },
            { month: 'julho', date: '05.06.2025', service: 'ABACUS.AI', usd: '$10,00', brl: 'R$ 59,20', category: 'IA' },
            { month: 'julho', date: '06.06.2025', service: 'ABACUS.AI', usd: '$20,00', brl: 'R$ 118,80', category: 'IA' },
            { month: 'julho', date: '06.06.2025', service: 'SURFERSEO.COM', usd: '$219,00', brl: 'R$ 1.300,86', category: 'Marketing' },
            { month: 'julho', date: '07.06.2025', service: 'HUGGINGFACE', usd: '$60,00', brl: 'R$ 356,40', category: 'IA' },
            { month: 'julho', date: '09.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL101,22', brl: 'R$ 107,44', category: 'IA' },
            { month: 'julho', date: '09.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL101,12', brl: 'R$ 107,38', category: 'IA' },
            { month: 'julho', date: '10.06.2025', service: 'MIRO.COM', usd: '$120,00', brl: 'R$ 704,40', category: 'Colabora√ß√£o' },
            { month: 'julho', date: '10.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL95,73', brl: 'R$ 101,26', category: 'IA' },
            { month: 'julho', date: '10.06.2025', service: 'ABACUS.AI', usd: '$10,00', brl: 'R$ 58,70', category: 'IA' },
            { month: 'julho', date: '11.06.2025', service: 'ABACUS.AI', usd: '$10,00', brl: 'R$ 58,60', category: 'IA' },
            { month: 'julho', date: '12.06.2025', service: 'MERCADOLIVRE*RELOGIOSJU', usd: '-', brl: 'R$ 88,93', category: 'E-commerce' },
            { month: 'julho', date: '12.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL84,29', brl: 'R$ 89,63', category: 'IA' },
            { month: 'julho', date: '13.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL79,94', brl: 'R$ 85,08', category: 'IA' },
            { month: 'julho', date: '16.06.2025', service: 'DIDWW', usd: '$50,00', brl: 'R$ 292,00', category: 'Telefonia' },
            { month: 'julho', date: '18.06.2025', service: 'MERLIN', usd: '$1,98', brl: 'R$ 11,50', category: 'IA' },
            { month: 'julho', date: '20.06.2025', service: 'ANTHROPIC', usd: '$25,00', brl: 'R$ 146,25', category: 'IA' },
            { month: 'julho', date: '20.06.2025', service: 'MERLIN', usd: '$0,76', brl: 'R$ 4,45', category: 'IA' },
            { month: 'julho', date: '21.06.2025', service: 'MERLIN', usd: '$228,00', brl: 'R$ 1.333,80', category: 'IA' },
            { month: 'julho', date: '22.06.2025', service: 'BOLT (BY STACKBLITZ)', usd: '$840,00', brl: 'R$ 4.914,00', category: 'Desenvolvimento' },
            { month: 'julho', date: '22.06.2025', service: 'WWW.PERPLEXITY.AI', usd: '$20,00', brl: 'R$ 117,00', category: 'IA' },
            { month: 'julho', date: '23.06.2025', service: 'CURSOR, AI POWERED IDE', usd: '$40,00', brl: 'R$ 233,20', category: 'Desenvolvimento' },
            { month: 'julho', date: '23.06.2025', service: 'CURSOR, AI POWERED IDE', usd: '$200,00', brl: 'R$ 1.166,00', category: 'Desenvolvimento' },
            { month: 'julho', date: '23.06.2025', service: 'CURSOR, AI POWERED IDE', usd: '$39,99', brl: 'R$ 233,14', category: 'Desenvolvimento' },
            { month: 'julho', date: '23.06.2025', service: 'CURSOR, AI POWERED IDE', usd: '$40,00', brl: 'R$ 233,20', category: 'Desenvolvimento' },
            { month: 'julho', date: '23.06.2025', service: 'ABACUS.AI', usd: '$10,00', brl: 'R$ 58,30', category: 'IA' },
            { month: 'julho', date: '24.06.2025', service: 'MERCADOPAGO*ALPHACAMP', usd: '-', brl: 'R$ 125,61', category: 'Outros' },
            { month: 'julho', date: '24.06.2025', service: 'CURSOR, AI POWERED IDE', usd: '$38,68', brl: 'R$ 224,73', category: 'Desenvolvimento' },
            { month: 'julho', date: '24.06.2025', service: 'OPENAI', usd: '$92,04', brl: 'R$ 534,75', category: 'IA' },
            { month: 'julho', date: '25.06.2025', service: 'WWW.PERPLEXITY.AI', usd: '$35,74', brl: 'R$ 209,79', category: 'IA' },
            { month: 'julho', date: '25.06.2025', service: 'DOCKER, INC.', usd: '$11,00', brl: 'R$ 64,57', category: 'Desenvolvimento' },
            { month: 'julho', date: '26.06.2025', service: 'PPRO*MICROSOFT', usd: '-', brl: 'R$ 136,90', category: 'Cloud' },
            { month: 'julho', date: '26.06.2025', service: 'ABACUS.AI', usd: '$21,00', brl: 'R$ 122,85', category: 'IA' },
            { month: 'julho', date: '26.06.2025', service: 'ABACUS.AI', usd: '$10,00', brl: 'R$ 58,50', category: 'IA' },
            { month: 'julho', date: '26.06.2025', service: 'OPENAI', usd: '$93,62', brl: 'R$ 547,68', category: 'IA' },
            { month: 'julho', date: '26.06.2025', service: 'PADDLE.NET* N8N CLOUD1', usd: 'BRL375,00', brl: 'R$ 398,44', category: 'Automa√ß√£o' },
            { month: 'julho', date: '27.06.2025', service: 'ZAPIER.COM/CHARGE', usd: 'BRL584,04', brl: 'R$ 617,24', category: 'Automa√ß√£o' },
            { month: 'julho', date: '27.06.2025', service: 'ABACUS.AI', usd: '$20,00', brl: 'R$ 116,00', category: 'IA' },
            { month: 'julho', date: '27.06.2025', service: 'MERLIN', usd: '$15,35', brl: 'R$ 89,03', category: 'IA' },
            { month: 'julho', date: '27.06.2025', service: 'DIDWW', usd: '$50,00', brl: 'R$ 290,00', category: 'Telefonia' },
            { month: 'julho', date: '28.06.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL3.262,68', brl: 'R$ 3.467,30', category: 'IA' },
            { month: 'julho', date: '29.06.2025', service: 'MERLIN', usd: '$14,18', brl: 'R$ 82,24', category: 'IA' },
            { month: 'julho', date: '29.06.2025', service: 'WWW.PERPLEXITY.AI', usd: '$38,40', brl: 'R$ 222,72', category: 'IA' },
            { month: 'julho', date: '30.06.2025', service: 'ANTHROPIC', usd: '$64,00', brl: 'R$ 368,64', category: 'IA' },
            { month: 'julho', date: '30.06.2025', service: 'ABACUS.AI', usd: '$8,66', brl: 'R$ 49,88', category: 'IA' },
            { month: 'julho', date: '30.06.2025', service: 'ABACUS.AI', usd: '$10,00', brl: 'R$ 57,60', category: 'IA' },
            { month: 'julho', date: '30.06.2025', service: 'OPENAI *CHATGPT SUBSCR', usd: '$293,09', brl: 'R$ 1.688,20', category: 'IA' },
            { month: 'julho', date: '30.06.2025', service: 'OPENAI *CHATGPT SUBSCR', usd: '$120,00', brl: 'R$ 691,20', category: 'IA' },
            { month: 'julho', date: '30.06.2025', service: 'MERLIN', usd: '$13,59', brl: 'R$ 78,28', category: 'IA' },
            { month: 'julho', date: '01.07.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL148,27', brl: 'R$ 158,03', category: 'IA' },
            { month: 'julho', date: '01.07.2025', service: 'ABACUS.AI', usd: '$10,00', brl: 'R$ 57,80', category: 'IA' },
            { month: 'julho', date: '01.07.2025', service: 'ABACUS.AI', usd: '$30,00', brl: 'R$ 173,40', category: 'IA' },
            { month: 'julho', date: '01.07.2025', service: 'OPENAI', usd: '$91,21', brl: 'R$ 527,19', category: 'IA' },
            { month: 'julho', date: '02.07.2025', service: 'AWS BRAZIL', usd: '-', brl: 'R$ 98,34', category: 'Cloud' },
            { month: 'julho', date: '02.07.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL143,32', brl: 'R$ 152,62', category: 'IA' },
            { month: 'julho', date: '02.07.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL143,32', brl: 'R$ 152,62', category: 'IA' },
            { month: 'julho', date: '03.07.2025', service: 'MSFT * E0500WQDNB', usd: '-', brl: 'R$ 119,00', category: 'Cloud' },
            { month: 'julho', date: '03.07.2025', service: 'MSFT * E0500WQB7J', usd: '-', brl: 'R$ 1.190,10', category: 'Cloud' },
            { month: 'julho', date: '03.07.2025', service: 'MSFT * E0500WQB7K', usd: '-', brl: 'R$ 535,50', category: 'Cloud' },
            { month: 'julho', date: '03.07.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL137,51', brl: 'R$ 145,80', category: 'IA' },
            { month: 'julho', date: '03.07.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL135,90', brl: 'R$ 144,07', category: 'IA' },
            { month: 'julho', date: '04.07.2025', service: 'CREWAI, INC.', usd: '$99,00', brl: 'R$ 566,28', category: 'IA' },
            { month: 'julho', date: '04.07.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL131,85', brl: 'R$ 139,63', category: 'IA' },
            { month: 'julho', date: '04.07.2025', service: 'ANTHROPIC: CLAUDE TEAM', usd: 'BRL131,84', brl: 'R$ 139,57', category: 'IA' },
            { month: 'julho', date: '04.07.2025', service: 'CURSOR, AI POWERED IDE', usd: '$25,28', brl: 'R$ 144,60', category: 'Desenvolvimento' },
            { month: 'julho', date: '04.07.2025', service: 'SUPABASE', usd: '$38,12', brl: 'R$ 218,05', category: 'Cloud' },
            { month: 'julho', date: '04.07.2025', service: 'DEEPL* SUB:77ETPUNACUT', usd: '$44,39', brl: 'R$ 253,91', category: 'Ferramentas' },
            { month: 'julho', date: '05.07.2025', service: 'ABACUS.AI', usd: '$141,31', brl: 'R$ 808,29', category: 'IA' }
        ];

        // Vari√°veis globais
        let filteredTransactions = allTransactions;
        let currentMonth = 'all';
        let currentCategory = 'all';
        let categoryChart = null;
        let timelineChart = null;
        let chatOpen = false;
        let isTyping = false;
        let geminiApiKey = '';

        // ===== GEMINI AI INTEGRATION FOR NETLIFY =====
        
        // Fun√ß√£o para inicializar API Key no Netlify
        function initializeApiKey() {
            // Tentar carregar da vari√°vel de ambiente do Netlify
            if (window.netlifyIdentity) {
                // Se usando Netlify Identity, pode acessar env vars
                try {
                    geminiApiKey = process.env.GEMINI_API_KEY || '';
                } catch (e) {
                    console.log('Vari√°vel de ambiente n√£o acess√≠vel diretamente');
                }
            }
            
            // Fallback para localStorage
            if (!geminiApiKey) {
                const storedKey = localStorage.getItem('geminiApiKey');
                if (storedKey) {
                    geminiApiKey = storedKey;
                    document.getElementById('apiKeySection').style.display = 'none';
                    return true;
                }
            } else {
                document.getElementById('apiKeySection').style.display = 'none';
                return true;
            }
            
            // Mostrar se√ß√£o de configura√ß√£o
            document.getElementById('apiKeySection').style.display = 'block';
            return false;
        }
        
        // Fun√ß√£o para salvar chave da API
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                geminiApiKey = apiKey;
                document.getElementById('apiKeySection').style.display = 'none';
                addMessage('üîë Chave da API salva com sucesso! Agora posso responder suas perguntas com IA avan√ßada.', 'assistant');
            } else {
                alert('Por favor, insira uma chave da API v√°lida.');
            }
        }

        // Fun√ß√£o para verificar se a API est√° configurada
        function checkApiKey() {
            return geminiApiKey !== '';
        }

        // Fun√ß√£o para processar resposta da IA com Gemini
        async function processAIResponse(question) {
            isTyping = true;
            showTypingIndicator();
            
            try {
                let response;
                
                if (checkApiKey()) {
                    // Usar Gemini AI via fun√ß√£o Netlify
                    response = await callGeminiViaNetlify(question);
                } else {
                    // Fallback para sistema local
                    response = generateLocalAIResponse(question);
                }
                
                hideTypingIndicator();
                addMessage(response, 'assistant');
                
            } catch (error) {
                hideTypingIndicator();
                console.error('Erro ao processar resposta:', error);
                
                const errorResponse = `‚ùå <strong>Erro ao conectar com o Gemini AI.</strong><br><br>
                Usando sistema local como backup...<br><br>
                ${generateLocalAIResponse(question)}`;
                
                addMessage(errorResponse, 'assistant');
            }
            
            isTyping = false;
        }

        // Fun√ß√£o para chamar Gemini via fun√ß√£o Netlify
        async function callGeminiViaNetlify(question) {
            const prompt = createPromptForGemini(question);
            
            try {
                // Primeiro, tentar via fun√ß√£o Netlify (se configurada)
                const netlifyResponse = await fetch('/.netlify/functions/gemini-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: prompt
                    })
                });

                if (netlifyResponse.ok) {
                    const data = await netlifyResponse.json();
                    return data.response;
                }
            } catch (error) {
                console.log('Fun√ß√£o Netlify n√£o dispon√≠vel, usando API direta');
            }
            
            // Fallback para API direta
            return await callGeminiDirectly(question);
        }

        // Fun√ß√£o para chamar a API do Gemini diretamente
        async function callGeminiDirectly(question) {
            const prompt = createPromptForGemini(question);
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`Erro na API: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Resposta inv√°lida da API');
            }
        }

        // Fun√ß√£o para criar prompt contextual para o Gemini
        function createPromptForGemini(question) {
            const stats = calculateCurrentStats();
            const dataContext = prepareDataContext();
            
            return `Voc√™ √© um assistente financeiro especializado em an√°lise de gastos de cart√£o corporativo.

CONTEXTO DOS DADOS:
${dataContext}

ESTAT√çSTICAS ATUAIS DOS DADOS FILTRADOS:
- Total de transa√ß√µes: ${stats.transactions}
- Valor total: R$ ${stats.totalBRL.toLocaleString('pt-BR')}
- M√©dia por transa√ß√£o: R$ ${Math.round(stats.avgTransaction).toLocaleString('pt-BR')}
- Per√≠odo: ${stats.period}
- Categoria principal: ${stats.topCategory}
- Gastos com IA: ${stats.aiPercentage}%

PERGUNTA DO USU√ÅRIO: "${question}"

INSTRU√á√ïES:
1. Responda de forma natural e conversacional
2. Use os dados fornecidos para dar respostas precisas
3. Inclua n√∫meros e estat√≠sticas relevantes
4. Use formata√ß√£o HTML para destacar informa√ß√µes importantes (<strong>, <br>)
5. Seja espec√≠fico e √∫til
6. Se a pergunta n√£o for sobre os dados, explique que voc√™ √© especializado em an√°lise financeira destes dados

Responda de forma direta e √∫til:`;
        }

        // Fun√ß√£o para preparar contexto dos dados
        function prepareDataContext() {
            const topServices = getTopServicesForContext();
            const topCategories = getTopCategoriesForContext();
            const monthlyBreakdown = getMonthlyBreakdownForContext();
            
            return `DADOS DO CART√ÉO CORPORATIVO:
Per√≠odo: Maio a Julho 2025
Profissional: Jorge Jamil
Departamento: Technology

PRINCIPAIS SERVI√áOS:
${topServices}

PRINCIPAIS CATEGORIAS:
${topCategories}

RESUMO MENSAL:
${monthlyBreakdown}

FILTROS ATIVOS:
- M√™s: ${currentMonth === 'all' ? 'Todos os meses' : currentMonth}
- Categoria: ${currentCategory === 'all' ? 'Todas as categorias' : currentCategory}`;
        }

        // Fun√ß√£o para obter top servi√ßos para contexto
        function getTopServicesForContext() {
            const serviceStats = {};
            filteredTransactions.forEach(t => {
                serviceStats[t.service] = (serviceStats[t.service] || 0) + parseBRL(t.brl);
            });
            
            return Object.entries(serviceStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([service, total]) => `- ${service}: R$ ${total.toLocaleString('pt-BR')}`)
                .join('\n');
        }

        // Fun√ß√£o para obter top categorias para contexto
        function getTopCategoriesForContext() {
            const categoryStats = {};
            filteredTransactions.forEach(t => {
                categoryStats[t.category] = (categoryStats[t.category] || 0) + parseBRL(t.brl);
            });
            
            return Object.entries(categoryStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([category, total]) => `- ${category}: R$ ${total.toLocaleString('pt-BR')}`)
                .join('\n');
        }

        // Fun√ß√£o para obter breakdown mensal para contexto
        function getMonthlyBreakdownForContext() {
            const monthlyData = {};
            ['maio', 'junho', 'julho'].forEach(month => {
                const monthTransactions = allTransactions.filter(t => t.month === month);
                const total = monthTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0);
                monthlyData[month] = `${month.charAt(0).toUpperCase() + month.slice(1)}: R$ ${total.toLocaleString('pt-BR')} (${monthTransactions.length} transa√ß√µes)`;
            });
            
            return Object.values(monthlyData).join('\n');
        }

        // Fun√ß√£o fallback para sistema local (backup)
        function generateLocalAIResponse(question) {
            const lowerQuestion = question.toLowerCase();
            const stats = calculateCurrentStats();
            
            // Respostas b√°sicas como fallback
            if (lowerQuestion.includes('maior gasto')) {
                const largest = findLargestTransaction();
                return `üí∞ A maior transa√ß√£o foi de <strong>${largest.brl}</strong> em ${largest.date} para <strong>${largest.service}</strong>.`;
            }
            
            if (lowerQuestion.includes('resumo')) {
                return `üìä <strong>Resumo dos dados:</strong><br><br>
                ‚Ä¢ Total: <strong>R$ ${stats.totalBRL.toLocaleString('pt-BR')}</strong><br>
                ‚Ä¢ Transa√ß√µes: <strong>${stats.transactions}</strong><br>
                ‚Ä¢ M√©dia: <strong>R$ ${Math.round(stats.avgTransaction).toLocaleString('pt-BR')}</strong><br>
                ‚Ä¢ Per√≠odo: <strong>${stats.period}</strong>`;
            }
            
            return `ü§ñ <strong>Sistema local ativo.</strong><br><br>
            Para respostas mais inteligentes, configure sua chave da API do Gemini.<br><br>
            Dados atuais: ${stats.transactions} transa√ß√µes, R$ ${stats.totalBRL.toLocaleString('pt-BR')} total.`;
        }

        // ===== CHAT AI FUNCTIONS (GLOBAL SCOPE) =====
        
        // Fun√ß√£o para alternar chat
        function toggleChat() {
            const chatWidget = document.getElementById('chatWidget');
            const chatToggle = document.getElementById('chatToggle');
            
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                chatWidget.classList.add('open');
                chatToggle.classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('chatInput').focus();
                }, 300);
            } else {
                chatWidget.classList.remove('open');
                chatToggle.classList.remove('hidden');
            }
        }

        // Fun√ß√£o para enviar mensagem
        function sendMessage(event) {
            event.preventDefault();
            
            if (isTyping) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Adicionar mensagem do usu√°rio
            addMessage(message, 'user');
            input.value = '';
            
            // Processar resposta da IA
            processAIResponse(message);
        }

        // Fun√ß√£o para enviar pergunta sugerida
        function sendSuggestedQuestion(question) {
            if (isTyping) return;
            
            const input = document.getElementById('chatInput');
            input.value = question;
            
            // Simular o envio da mensagem
            addMessage(question, 'user');
            input.value = '';
            processAIResponse(question);
        }

        // Fun√ß√£o para adicionar mensagem ao chat
        function addMessage(content, type) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            const avatar = type === 'user' ? 'üë§' : 'ü§ñ';
            const avatarClass = type === 'user' ? 'user' : 'assistant';
            
            messageDiv.innerHTML = `
                <div class="message-avatar ${avatarClass}">${avatar}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Fun√ß√£o para mostrar indicador de digita√ß√£o
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar assistant">ü§ñ</div>
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Fun√ß√£o para remover indicador de digita√ß√£o
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Fun√ß√£o para converter valor BRL para n√∫mero
        function parseBRL(value) {
            if (!value || value === '-') return 0;
            return parseFloat(value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
        }

        // Fun√ß√£o para converter valor USD para n√∫mero
        function parseUSD(value) {
            if (!value || value === '-') return 0;
            return parseFloat(value.replace('$', '').replace(/\./g, '').replace(',', '.').trim());
        }

        // Fun√ß√£o para filtrar transa√ß√µes
        function filterTransactions() {
            filteredTransactions = allTransactions.filter(transaction => {
                const monthMatch = currentMonth === 'all' || transaction.month === currentMonth;
                const categoryMatch = currentCategory === 'all' || transaction.category === currentCategory;
                return monthMatch && categoryMatch;
            });
        }

        // Fun√ß√£o para atualizar estat√≠sticas
        function updateStats() {
            const totalTransactions = filteredTransactions.length;
            
            let totalBRL = 0;
            let totalUSD = 0;
            let aiTransactions = 0;
            const uniqueDays = new Set();

            filteredTransactions.forEach(transaction => {
                totalBRL += parseBRL(transaction.brl);
                totalUSD += parseUSD(transaction.usd);
                
                if (transaction.category === 'IA') {
                    aiTransactions++;
                }
                
                uniqueDays.add(transaction.date);
            });

            const avgTransaction = totalTransactions > 0 ? totalBRL / totalTransactions : 0;
            const aiPercentage = totalTransactions > 0 ? Math.round((aiTransactions / totalTransactions) * 100) : 0;

            // Atualizar elementos
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('totalBRL').textContent = `R$ ${(totalBRL / 1000).toFixed(1)}K`;
            document.getElementById('totalUSD').textContent = `$ ${(totalUSD / 1000).toFixed(1)}K`;
            document.getElementById('avgTransaction').textContent = `R$ ${Math.round(avgTransaction)}`;
            document.getElementById('aiPercentage').textContent = `${aiPercentage}%`;
            document.getElementById('activeDays').textContent = uniqueDays.size;
        }

        // Fun√ß√£o para popular top servi√ßos
        function populateTopServices() {
            const serviceStats = {};
            
            filteredTransactions.forEach(transaction => {
                const serviceName = transaction.service;
                if (!serviceStats[serviceName]) {
                    serviceStats[serviceName] = {
                        count: 0,
                        totalBRL: 0
                    };
                }
                serviceStats[serviceName].count++;
                serviceStats[serviceName].totalBRL += parseBRL(transaction.brl);
            });

            const topServicesList = Object.entries(serviceStats)
                .sort(([,a], [,b]) => b.totalBRL - a.totalBRL)
                .slice(0, 10);

            const servicesGrid = document.getElementById('servicesGrid');
            servicesGrid.innerHTML = '';
            
            topServicesList.forEach(([serviceName, stats]) => {
                const serviceItem = document.createElement('div');
                serviceItem.className = 'service-item';
                serviceItem.innerHTML = `
                    <div class="service-name">${serviceName}</div>
                    <div class="service-count">${stats.count} transa√ß√µes</div>
                    <div class="service-value">R$ ${stats.totalBRL.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                `;
                servicesGrid.appendChild(serviceItem);
            });
        }

        // Fun√ß√£o para popular tabela de transa√ß√µes
        function populateTransactionsTable() {
            const transactionsTable = document.getElementById('transactionsTable');
            transactionsTable.innerHTML = '';
            
            // Ordenar por data mais recente primeiro
            const sortedTransactions = [...filteredTransactions].sort((a, b) => {
                const dateA = new Date(a.date.split('.').reverse().join('-'));
                const dateB = new Date(b.date.split('.').reverse().join('-'));
                return dateB - dateA;
            });
            
            sortedTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="month-indicator month-${transaction.month}">${transaction.month.charAt(0).toUpperCase() + transaction.month.slice(1)}</span></td>
                    <td class="data">${transaction.date}</td>
                    <td class="movimentacao">${transaction.service}</td>
                    <td class="valor-usd">${transaction.usd}</td>
                    <td class="valor-brl">${transaction.brl}</td>
                    <td><span style="padding: 2px 8px; background: #e3f2fd; border-radius: 12px; font-size: 11px; color: #1976d2;">${transaction.category}</span></td>
                `;
                transactionsTable.appendChild(row);
            });
        }

        // Fun√ß√£o para criar gr√°ficos
        function createCharts() {
            // Gr√°fico de categorias
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                            '#ffecd2', '#ff9a9e', '#a8edea', '#fed6e3'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // Gr√°fico de timeline mensal
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: ['Maio', 'Junho', 'Julho'],
                    datasets: [{
                        label: 'Gastos (R$)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            updateCharts();
        }

        // Fun√ß√£o para atualizar gr√°ficos
        function updateCharts() {
            // Verificar se os gr√°ficos existem antes de atualiz√°-los
            if (!categoryChart || !timelineChart) {
                return;
            }

            // Atualizar gr√°fico de categorias
            const categoryData = {};
            filteredTransactions.forEach(transaction => {
                const category = transaction.category;
                if (!categoryData[category]) {
                    categoryData[category] = 0;
                }
                categoryData[category] += parseBRL(transaction.brl);
            });

            const sortedCategories = Object.entries(categoryData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            if (categoryChart.data) {
                categoryChart.data.labels = sortedCategories.map(([category]) => category);
                categoryChart.data.datasets[0].data = sortedCategories.map(([,value]) => value);
                categoryChart.update();
            }

            // Atualizar gr√°fico de timeline mensal
            const monthlyData = { maio: 0, junho: 0, julho: 0 };

            allTransactions.forEach(transaction => {
                monthlyData[transaction.month] += parseBRL(transaction.brl);
            });

            if (timelineChart.data) {
                if (currentMonth === 'all') {
                    timelineChart.data.datasets[0].data = [
                        monthlyData.maio,
                        monthlyData.junho,
                        monthlyData.julho
                    ];
                } else {
                    const selectedMonthData = [0, 0, 0];
                    const monthIndex = currentMonth === 'maio' ? 0 : currentMonth === 'junho' ? 1 : 2;
                    selectedMonthData[monthIndex] = monthlyData[currentMonth];
                    timelineChart.data.datasets[0].data = selectedMonthData;
                }
                
                timelineChart.update();
            }
        }

        // Fun√ß√£o para atualizar dashboard
        function updateDashboard() {
            filterTransactions();
            updateStats();
            populateTopServices();
            populateTransactionsTable();
            
            // S√≥ atualizar gr√°ficos se eles j√° foram criados
            if (categoryChart && timelineChart) {
                updateCharts();
            }
        }

        // Fun√ß√£o para configurar event listeners
        function setupEventListeners() {
            // Filtro por m√™s
            document.querySelectorAll('.month-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentMonth = tab.dataset.month;
                    updateDashboard();
                });
            });

            // Filtro por categoria
            document.getElementById('categoryFilter').addEventListener('change', (e) => {
                currentCategory = e.target.value;
                updateDashboard();
            });
        }

        // Fun√ß√£o para inicializar dashboard
        function initDashboard() {
            try {
                // Primeiro configurar os listeners
                setupEventListeners();
                
                // Depois atualizar dados (sem gr√°ficos ainda)
                filterTransactions();
                updateStats();
                populateTopServices();
                populateTransactionsTable();
                
                // Por √∫ltimo criar os gr√°ficos
                createCharts();
                
                console.log('Dashboard inicializado com sucesso!');
            } catch (error) {
                console.error('Erro ao inicializar dashboard:', error);
            }
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
            initChatEventListeners();
        });

        // Fun√ß√£o para inicializar event listeners do chat
        function initChatEventListeners() {
            // Adicionar atalhos de teclado
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && chatOpen) {
                    toggleChat();
                }
            });
        }

        // ===== CHAT AI PROCESSING FUNCTIONS =====

        // Fun√ß√£o para processar resposta da IA
        function processAIResponse(question) {
            isTyping = true;
            showTypingIndicator();
            
            // Simular delay da API
            setTimeout(() => {
                hideTypingIndicator();
                const response = generateAIResponse(question);
                addMessage(response, 'assistant');
                isTyping = false;
            }, 1000 + Math.random() * 2000);
        }

        // Fun√ß√£o para gerar resposta da IA baseada nos dados
        function generateAIResponse(question) {
            const lowerQuestion = question.toLowerCase();
            
            // Calcular estat√≠sticas dos dados filtrados
            const stats = calculateCurrentStats();
            
            // Sistema de an√°lise de linguagem natural expandido
            
            // 1. AN√ÅLISES DE VALORES E GASTOS
            if (containsKeywords(lowerQuestion, ['maior', 'mais caro', 'maior gasto', 'mais alto', 'm√°ximo'])) {
                if (containsKeywords(lowerQuestion, ['categoria'])) {
                    const topCategory = getTopCategory();
                    return `üí∞ A categoria com maior gasto √© <strong>${topCategory.name}</strong> com <strong>R$ ${topCategory.total.toLocaleString('pt-BR')}</strong> em ${topCategory.transactions} transa√ß√µes.`;
                }
                if (containsKeywords(lowerQuestion, ['servi√ßo', 'empresa', 'fornecedor'])) {
                    const topService = getTopService();
                    return `üè¢ O servi√ßo com maior gasto √© <strong>${topService.name}</strong> com <strong>R$ ${topService.total.toLocaleString('pt-BR')}</strong> em ${topService.transactions} transa√ß√µes.`;
                }
                const largest = findLargestTransaction();
                return `üí∞ A maior transa√ß√£o foi de <strong>${largest.brl}</strong> em ${largest.date} para <strong>${largest.service}</strong> na categoria ${largest.category}.`;
            }
            
            if (containsKeywords(lowerQuestion, ['menor', 'mais barato', 'menor gasto', 'mais baixo', 'm√≠nimo'])) {
                const smallest = findSmallestTransaction();
                return `üí∏ A menor transa√ß√£o foi de <strong>${smallest.brl}</strong> em ${smallest.date} para <strong>${smallest.service}</strong> na categoria ${smallest.category}.`;
            }
            
            if (containsKeywords(lowerQuestion, ['m√©dia', 'm√©dio', 'average'])) {
                return `üìä A m√©dia de gasto por transa√ß√£o √© <strong>R$ ${Math.round(stats.avgTransaction).toLocaleString('pt-BR')}</strong>. ${stats.transactions} transa√ß√µes no total.`;
            }
            
            // 2. AN√ÅLISES POR CATEGORIA
            if (containsKeywords(lowerQuestion, ['ia', 'intelig√™ncia artificial', 'ai', 'artificial intelligence'])) {
                const aiStats = getAIStats();
                return `ü§ñ <strong>An√°lise de gastos com IA:</strong><br><br>
                ‚Ä¢ Total gasto: <strong>R$ ${aiStats.total.toLocaleString('pt-BR')}</strong><br>
                ‚Ä¢ N√∫mero de transa√ß√µes: <strong>${aiStats.transactions}</strong><br>
                ‚Ä¢ Porcentagem do total: <strong>${aiStats.percentage}%</strong><br>
                ‚Ä¢ Principais servi√ßos: <strong>${aiStats.topServices.join(', ')}</strong><br>
                ‚Ä¢ M√©dia por transa√ß√£o: <strong>R$ ${Math.round(aiStats.total / aiStats.transactions).toLocaleString('pt-BR')}</strong>`;
            }
            
            if (containsKeywords(lowerQuestion, ['desenvolvimento', 'dev', 'programa√ß√£o', 'c√≥digo'])) {
                return getCategoryAnalysis('Desenvolvimento');
            }
            
            if (containsKeywords(lowerQuestion, ['cloud', 'nuvem', 'microsoft', 'azure', 'aws'])) {
                return getCategoryAnalysis('Cloud');
            }
            
            if (containsKeywords(lowerQuestion, ['educa√ß√£o', 'curso', 'aprendizado', 'treinamento'])) {
                return getCategoryAnalysis('Educa√ß√£o');
            }
            
            if (containsKeywords(lowerQuestion, ['hardware', 'equipamento', 'computador', 'eletr√¥nico'])) {
                return getCategoryAnalysis('Hardware');
            }
            
            if (containsKeywords(lowerQuestion, ['e-commerce', 'mercadolivre', 'compras', 'loja'])) {
                return getCategoryAnalysis('E-commerce');
            }
            
            // 3. AN√ÅLISES TEMPORAIS
            if (containsKeywords(lowerQuestion, ['maio'])) {
                return getDetailedMonthAnalysis('maio');
            }
            
            if (containsKeywords(lowerQuestion, ['junho'])) {
                return getDetailedMonthAnalysis('junho');
            }
            
            if (containsKeywords(lowerQuestion, ['julho'])) {
                return getDetailedMonthAnalysis('julho');
            }
            
            if (containsKeywords(lowerQuestion, ['comparar', 'compara√ß√£o', 'versus', 'vs', 'diferen√ßa'])) {
                return getDetailedComparison();
            }
            
            if (containsKeywords(lowerQuestion, ['crescimento', 'tend√™ncia', 'evolu√ß√£o', 'progresso'])) {
                return getTrendAnalysis();
            }
            
            // 4. AN√ÅLISES DE FREQU√äNCIA
            if (containsKeywords(lowerQuestion, ['frequente', 'mais usado', 'repetido', 'recorrente'])) {
                return getFrequencyAnalysis();
            }
            
            if (containsKeywords(lowerQuestion, ['quantas', 'quantidade', 'n√∫mero', 'count'])) {
                if (containsKeywords(lowerQuestion, ['transa√ß√µes', 'transa√ß√£o'])) {
                    return `üìä Voc√™ tem <strong>${stats.transactions} transa√ß√µes</strong> no per√≠odo selecionado.`;
                }
                if (containsKeywords(lowerQuestion, ['categoria', 'categorias'])) {
                    const categories = getUniqueCategoriesCount();
                    return `üìÇ Voc√™ tem gastos em <strong>${categories.count} categorias</strong> diferentes: ${categories.list.join(', ')}.`;
                }
            }
            
            // 5. AN√ÅLISES DE FORNECEDORES ESPEC√çFICOS
            if (containsKeywords(lowerQuestion, ['openai', 'chatgpt'])) {
                return getServiceAnalysis('OPENAI');
            }
            
            if (containsKeywords(lowerQuestion, ['anthropic', 'claude'])) {
                return getServiceAnalysis('ANTHROPIC');
            }
            
            if (containsKeywords(lowerQuestion, ['microsoft', 'msft'])) {
                return getServiceAnalysis('MICROSOFT');
            }
            
            if (containsKeywords(lowerQuestion, ['bolt', 'stackblitz'])) {
                return getServiceAnalysis('BOLT');
            }
            
            // 6. AN√ÅLISES DE PADR√ïES
            if (containsKeywords(lowerQuestion, ['padr√£o', 'comportamento', 'h√°bito'])) {
                return getPatternAnalysis();
            }
            
            if (containsKeywords(lowerQuestion, ['recomenda√ß√£o', 'sugest√£o', 'conselho', 'otimiza√ß√£o'])) {
                return getRecommendations();
            }
            
            // 7. AN√ÅLISES FINANCEIRAS
            if (containsKeywords(lowerQuestion, ['or√ßamento', 'budget', 'limite', 'controle'])) {
                return getBudgetAnalysis();
            }
            
            if (containsKeywords(lowerQuestion, ['economia', 'economizar', 'reduzir', 'cortar'])) {
                return getSavingsAnalysis();
            }
            
            // 8. RESUMOS E RELAT√ìRIOS
            if (containsKeywords(lowerQuestion, ['resumo', 'overview', 'relat√≥rio', 'sum√°rio'])) {
                return getComprehensiveReport();
            }
            
            if (containsKeywords(lowerQuestion, ['tudo', 'todos', 'geral', 'total'])) {
                return getOverallAnalysis();
            }
            
            // 9. AN√ÅLISES ESPEC√çFICAS POR VALOR
            if (containsKeywords(lowerQuestion, ['acima', 'maior que', 'superior'])) {
                const threshold = extractNumber(lowerQuestion);
                if (threshold) {
                    return getTransactionsAboveThreshold(threshold);
                }
            }
            
            if (containsKeywords(lowerQuestion, ['abaixo', 'menor que', 'inferior'])) {
                const threshold = extractNumber(lowerQuestion);
                if (threshold) {
                    return getTransactionsBelowThreshold(threshold);
                }
            }
            
            // 10. BUSCA POR NOME/SERVI√áO
            const searchTerm = extractSearchTerm(lowerQuestion);
            if (searchTerm && (containsKeywords(lowerQuestion, ['procurar', 'buscar', 'encontrar', 'achar']) || searchTerm.length > 3)) {
                return searchInTransactions(searchTerm);
            }
            
            // Resposta inteligente baseada no contexto
            return generateContextualResponse(lowerQuestion, stats);
        }

        // Fun√ß√£o auxiliar para verificar palavras-chave
        function containsKeywords(text, keywords) {
            return keywords.some(keyword => text.includes(keyword));
        }

        // Fun√ß√£o para extrair n√∫meros da pergunta
        function extractNumber(text) {
            const numbers = text.match(/\d+/g);
            return numbers ? parseInt(numbers[0]) : null;
        }

        // Fun√ß√£o para extrair termo de busca
        function extractSearchTerm(text) {
            const searchPatterns = [
                /(?:sobre|com|para|de|do|da)\s+(\w+)/,
                /(?:buscar|procurar|encontrar)\s+(\w+)/,
                /(\w+)(?:\s+gasto|s\s+transa√ß)/
            ];
            
            for (const pattern of searchPatterns) {
                const match = text.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // Fun√ß√£o para an√°lise detalhada por categoria
        function getCategoryAnalysis(category) {
            const categoryTransactions = filteredTransactions.filter(t => t.category === category);
            if (categoryTransactions.length === 0) {
                return `üìä N√£o h√° transa√ß√µes na categoria <strong>${category}</strong> no per√≠odo selecionado.`;
            }
            
            const total = categoryTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const avg = total / categoryTransactions.length;
            const largest = categoryTransactions.reduce((max, current) => 
                parseBRL(current.brl) > parseBRL(max.brl) ? current : max
            );
            
            const services = {};
            categoryTransactions.forEach(t => {
                services[t.service] = (services[t.service] || 0) + parseBRL(t.brl);
            });
            
            const topServices = Object.entries(services)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([service, value]) => `${service} (R$ ${value.toLocaleString('pt-BR')})`);
            
            return `üìä <strong>An√°lise da categoria ${category}:</strong><br><br>
            ‚Ä¢ Total gasto: <strong>R$ ${total.toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ N√∫mero de transa√ß√µes: <strong>${categoryTransactions.length}</strong><br>
            ‚Ä¢ M√©dia por transa√ß√£o: <strong>R$ ${Math.round(avg).toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ Maior transa√ß√£o: <strong>${largest.service}</strong> (${largest.brl})<br>
            ‚Ä¢ Principais servi√ßos: <strong>${topServices.join(', ')}</strong>`;
        }

        // Fun√ß√£o para an√°lise detalhada por m√™s
        function getDetailedMonthAnalysis(month) {
            const monthTransactions = allTransactions.filter(t => t.month === month);
            const total = monthTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const avg = total / monthTransactions.length;
            
            const categoryTotals = {};
            monthTransactions.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseBRL(t.brl);
            });
            
            const topCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([cat, value]) => `${cat} (R$ ${value.toLocaleString('pt-BR')})`);
            
            const largest = monthTransactions.reduce((max, current) => 
                parseBRL(current.brl) > parseBRL(max.brl) ? current : max
            );
            
            return `üóìÔ∏è <strong>An√°lise detalhada de ${month.charAt(0).toUpperCase() + month.slice(1)}:</strong><br><br>
            ‚Ä¢ Total gasto: <strong>R$ ${total.toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ N√∫mero de transa√ß√µes: <strong>${monthTransactions.length}</strong><br>
            ‚Ä¢ M√©dia por transa√ß√£o: <strong>R$ ${Math.round(avg).toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ Maior transa√ß√£o: <strong>${largest.service}</strong> (${largest.brl})<br>
            ‚Ä¢ Principais categorias: <strong>${topCategories.join(', ')}</strong><br>
            ‚Ä¢ Dias ativos: <strong>${new Set(monthTransactions.map(t => t.date)).size}</strong>`;
        }

        // Fun√ß√µes auxiliares expandidas para an√°lise completa
        
        function findSmallestTransaction() {
            return filteredTransactions.reduce((min, current) => 
                parseBRL(current.brl) < parseBRL(min.brl) ? current : min
            );
        }
        
        function getTopService() {
            const serviceStats = {};
            filteredTransactions.forEach(t => {
                serviceStats[t.service] = (serviceStats[t.service] || 0) + parseBRL(t.brl);
            });
            
            const [name, total] = Object.entries(serviceStats)
                .sort(([,a], [,b]) => b - a)[0] || ['N/A', 0];
            
            const transactions = filteredTransactions.filter(t => t.service === name).length;
            return { name, total, transactions };
        }
        
        function getServiceAnalysis(serviceName) {
            const serviceTransactions = filteredTransactions.filter(t => 
                t.service.toUpperCase().includes(serviceName.toUpperCase())
            );
            
            if (serviceTransactions.length === 0) {
                return `üîç N√£o foram encontradas transa√ß√µes para <strong>${serviceName}</strong> no per√≠odo selecionado.`;
            }
            
            const total = serviceTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const avg = total / serviceTransactions.length;
            const months = new Set(serviceTransactions.map(t => t.month)).size;
            
            return `üè¢ <strong>An√°lise de ${serviceName}:</strong><br><br>
            ‚Ä¢ Total gasto: <strong>R$ ${total.toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ N√∫mero de transa√ß√µes: <strong>${serviceTransactions.length}</strong><br>
            ‚Ä¢ M√©dia por transa√ß√£o: <strong>R$ ${Math.round(avg).toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ Meses ativos: <strong>${months}</strong><br>
            ‚Ä¢ Porcentagem do total: <strong>${((total / filteredTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0)) * 100).toFixed(1)}%</strong>`;
        }
        
        function getFrequencyAnalysis() {
            const serviceFreq = {};
            filteredTransactions.forEach(t => {
                serviceFreq[t.service] = (serviceFreq[t.service] || 0) + 1;
            });
            
            const topFrequent = Object.entries(serviceFreq)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([service, count]) => `${service} (${count}x)`);
            
            return `üîÑ <strong>Servi√ßos mais frequentes:</strong><br><br>
            ${topFrequent.map((item, index) => `${index + 1}. ${item}`).join('<br>')}`;
        }
        
        function getUniqueCategoriesCount() {
            const categories = [...new Set(filteredTransactions.map(t => t.category))];
            return {
                count: categories.length,
                list: categories
            };
        }
        
        function getDetailedComparison() {
            const monthlyStats = {};
            ['maio', 'junho', 'julho'].forEach(month => {
                const monthTransactions = allTransactions.filter(t => t.month === month);
                monthlyStats[month] = {
                    total: monthTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0),
                    transactions: monthTransactions.length,
                    avgTransaction: monthTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0) / monthTransactions.length
                };
            });
            
            const bestMonth = Object.entries(monthlyStats)
                .sort(([,a], [,b]) => a.total - b.total)[0][0];
            const worstMonth = Object.entries(monthlyStats)
                .sort(([,a], [,b]) => b.total - a.total)[0][0];
            
            return `üìä <strong>Compara√ß√£o detalhada:</strong><br><br>
            <strong>Maio:</strong> R$ ${monthlyStats.maio.total.toLocaleString('pt-BR')} (${monthlyStats.maio.transactions} transa√ß√µes)<br>
            <strong>Junho:</strong> R$ ${monthlyStats.junho.total.toLocaleString('pt-BR')} (${monthlyStats.junho.transactions} transa√ß√µes)<br>
            <strong>Julho:</strong> R$ ${monthlyStats.julho.total.toLocaleString('pt-BR')} (${monthlyStats.julho.transactions} transa√ß√µes)<br><br>
            üìà <strong>M√™s com menor gasto:</strong> ${bestMonth}<br>
            üìâ <strong>M√™s com maior gasto:</strong> ${worstMonth}`;
        }
        
        function getTrendAnalysis() {
            const monthlyTotals = {
                maio: allTransactions.filter(t => t.month === 'maio').reduce((sum, t) => sum + parseBRL(t.brl), 0),
                junho: allTransactions.filter(t => t.month === 'junho').reduce((sum, t) => sum + parseBRL(t.brl), 0),
                julho: allTransactions.filter(t => t.month === 'julho').reduce((sum, t) => sum + parseBRL(t.brl), 0)
            };
            
            const maioToJunho = ((monthlyTotals.junho - monthlyTotals.maio) / monthlyTotals.maio) * 100;
            const junhoToJulho = ((monthlyTotals.julho - monthlyTotals.junho) / monthlyTotals.junho) * 100;
            
            let trend = '';
            if (maioToJunho > 0 && junhoToJulho > 0) {
                trend = 'üìà Tend√™ncia crescente consistente nos gastos.';
            } else if (maioToJunho < 0 && junhoToJulho < 0) {
                trend = 'üìâ Tend√™ncia decrescente consistente nos gastos.';
            } else {
                trend = 'üìä Tend√™ncia irregular nos gastos.';
            }
            
            return `üìà <strong>An√°lise de tend√™ncia:</strong><br><br>
            ‚Ä¢ Maio ‚Üí Junho: <strong>${maioToJunho.toFixed(1)}%</strong><br>
            ‚Ä¢ Junho ‚Üí Julho: <strong>${junhoToJulho.toFixed(1)}%</strong><br><br>
            ${trend}`;
        }
        
        function getPatternAnalysis() {
            const dayOfWeekSpending = {};
            const categoryByMonth = {};
            
            filteredTransactions.forEach(t => {
                const date = new Date(t.date.split('.').reverse().join('-'));
                const dayOfWeek = date.toLocaleDateString('pt-BR', { weekday: 'long' });
                
                dayOfWeekSpending[dayOfWeek] = (dayOfWeekSpending[dayOfWeek] || 0) + parseBRL(t.brl);
                
                if (!categoryByMonth[t.month]) categoryByMonth[t.month] = {};
                categoryByMonth[t.month][t.category] = (categoryByMonth[t.month][t.category] || 0) + parseBRL(t.brl);
            });
            
            const topDayOfWeek = Object.entries(dayOfWeekSpending)
                .sort(([,a], [,b]) => b - a)[0];
            
            return `üîç <strong>An√°lise de padr√µes:</strong><br><br>
            ‚Ä¢ Dia da semana com mais gastos: <strong>${topDayOfWeek?.[0] || 'N/A'}</strong><br>
            ‚Ä¢ Valor no dia: <strong>R$ ${topDayOfWeek?.[1]?.toLocaleString('pt-BR') || '0'}</strong><br>
            ‚Ä¢ Categoria mais consistente: <strong>${getMostConsistentCategory()}</strong>`;
        }
        
        function getMostConsistentCategory() {
            const categoryByMonth = {};
            
            allTransactions.forEach(t => {
                if (!categoryByMonth[t.category]) categoryByMonth[t.category] = new Set();
                categoryByMonth[t.category].add(t.month);
            });
            
            const mostConsistent = Object.entries(categoryByMonth)
                .sort(([,a], [,b]) => b.size - a.size)[0];
            
            return mostConsistent?.[0] || 'N/A';
        }
        
        function getRecommendations() {
            const aiSpending = getAIStats();
            const topCategory = getTopCategory();
            const monthlyComparison = getMonthComparison();
            
            let recommendations = [];
            
            if (aiSpending.percentage > 40) {
                recommendations.push('ü§ñ Considere consolidar servi√ßos de IA para otimizar custos');
            }
            
            if (topCategory.total > (filteredTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0) * 0.4)) {
                recommendations.push(`üìä A categoria ${topCategory.name} representa mais de 40% dos gastos - considere revisar`);
            }
            
            if (monthlyComparison.julho > monthlyComparison.maio * 1.5) {
                recommendations.push('üìà Crescimento acelerado nos gastos - considere implementar controles');
            }
            
            const duplicateServices = findDuplicateServices();
            if (duplicateServices.length > 0) {
                recommendations.push(`üîÑ Servi√ßos similares detectados: ${duplicateServices.join(', ')}`);
            }
            
            return recommendations.length > 0 ? 
                `üí° <strong>Recomenda√ß√µes:</strong><br><br>${recommendations.map((r, i) => `${i + 1}. ${r}`).join('<br>')}` :
                '‚úÖ <strong>Seus gastos parecem bem organizados!</strong> Continue monitorando regularmente.';
        }
        
        function findDuplicateServices() {
            const services = filteredTransactions.map(t => t.service.toLowerCase());
            const duplicates = [];
            
            // L√≥gica simples para detectar servi√ßos similares
            const serviceGroups = {
                'openai': ['openai', 'chatgpt'],
                'anthropic': ['anthropic', 'claude'],
                'microsoft': ['microsoft', 'msft'],
                'mercadolivre': ['mercadolivre', 'mercadopago']
            };
            
            Object.entries(serviceGroups).forEach(([group, keywords]) => {
                const matches = services.filter(s => keywords.some(k => s.includes(k)));
                if (matches.length > 1) {
                    duplicates.push(group);
                }
            });
            
            return duplicates;
        }
        
        function getBudgetAnalysis() {
            const monthlyAvg = (filteredTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0)) / 3;
            const categoryDistribution = {};
            
            filteredTransactions.forEach(t => {
                categoryDistribution[t.category] = (categoryDistribution[t.category] || 0) + parseBRL(t.brl);
            });
            
            const topCategories = Object.entries(categoryDistribution)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);
            
            return `üí∞ <strong>An√°lise de or√ßamento:</strong><br><br>
            ‚Ä¢ M√©dia mensal: <strong>R$ ${monthlyAvg.toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ Distribui√ß√£o por categoria:<br>
            ${topCategories.map(([cat, value]) => 
                `&nbsp;&nbsp;‚Ä¢ ${cat}: R$ ${value.toLocaleString('pt-BR')} (${((value / filteredTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0)) * 100).toFixed(1)}%)`
            ).join('<br>')}`;
        }
        
        function getSavingsAnalysis() {
            const suggestions = [];
            const aiTotal = getAIStats().total;
            const topService = getTopService();
            
            if (aiTotal > 5000) {
                suggestions.push(`ü§ñ Potencial economia de R$ ${(aiTotal * 0.2).toLocaleString('pt-BR')} consolidando servi√ßos de IA`);
            }
            
            if (topService.total > 3000) {
                suggestions.push(`üè¢ Rever contrato com ${topService.name} - poss√≠vel economia de R$ ${(topService.total * 0.15).toLocaleString('pt-BR')}`);
            }
            
            return suggestions.length > 0 ?
                `üí° <strong>Oportunidades de economia:</strong><br><br>${suggestions.map((s, i) => `${i + 1}. ${s}`).join('<br>')}` :
                '‚úÖ <strong>Seus gastos est√£o otimizados!</strong> Continue monitorando.';
        }
        
        function getComprehensiveReport() {
            const stats = calculateCurrentStats();
            const topCategory = getTopCategory();
            const topService = getTopService();
            const aiStats = getAIStats();
            
            return `üìä <strong>Relat√≥rio Completo:</strong><br><br>
            <strong>üìà Resumo Financeiro:</strong><br>
            ‚Ä¢ Total gasto: R$ ${stats.totalBRL.toLocaleString('pt-BR')}<br>
            ‚Ä¢ Transa√ß√µes: ${stats.transactions}<br>
            ‚Ä¢ M√©dia: R$ ${Math.round(stats.avgTransaction).toLocaleString('pt-BR')}<br><br>
            
            <strong>üèÜ Principais Gastos:</strong><br>
            ‚Ä¢ Categoria: ${topCategory.name} (R$ ${topCategory.total.toLocaleString('pt-BR')})<br>
            ‚Ä¢ Servi√ßo: ${topService.name} (R$ ${topService.total.toLocaleString('pt-BR')})<br><br>
            
            <strong>ü§ñ An√°lise IA:</strong><br>
            ‚Ä¢ Total IA: R$ ${aiStats.total.toLocaleString('pt-BR')} (${aiStats.percentage}%)<br>
            ‚Ä¢ Principais: ${aiStats.topServices.slice(0, 2).join(', ')}<br><br>
            
            <strong>üìÖ Per√≠odo:</strong> ${stats.period}`;
        }
        
        function getOverallAnalysis() {
            const totalAll = allTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const totalTransactions = allTransactions.length;
            const uniqueServices = new Set(allTransactions.map(t => t.service)).size;
            const uniqueCategories = new Set(allTransactions.map(t => t.category)).size;
            
            return `üåü <strong>An√°lise Geral Completa:</strong><br><br>
            ‚Ä¢ Total geral: <strong>R$ ${totalAll.toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ Total de transa√ß√µes: <strong>${totalTransactions}</strong><br>
            ‚Ä¢ Servi√ßos √∫nicos: <strong>${uniqueServices}</strong><br>
            ‚Ä¢ Categorias: <strong>${uniqueCategories}</strong><br>
            ‚Ä¢ M√©dia geral: <strong>R$ ${Math.round(totalAll / totalTransactions).toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ Per√≠odo: <strong>Maio a Julho 2025</strong>`;
        }
        
        function getTransactionsAboveThreshold(threshold) {
            const above = filteredTransactions.filter(t => parseBRL(t.brl) > threshold);
            const total = above.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            
            return `üìä <strong>Transa√ß√µes acima de R$ ${threshold.toLocaleString('pt-BR')}:</strong><br><br>
            ‚Ä¢ Quantidade: <strong>${above.length}</strong><br>
            ‚Ä¢ Total: <strong>R$ ${total.toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ Porcentagem: <strong>${((above.length / filteredTransactions.length) * 100).toFixed(1)}%</strong>`;
        }
        
        function getTransactionsBelowThreshold(threshold) {
            const below = filteredTransactions.filter(t => parseBRL(t.brl) < threshold);
            const total = below.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            
            return `üìä <strong>Transa√ß√µes abaixo de R$ ${threshold.toLocaleString('pt-BR')}:</strong><br><br>
            ‚Ä¢ Quantidade: <strong>${below.length}</strong><br>
            ‚Ä¢ Total: <strong>R$ ${total.toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ Porcentagem: <strong>${((below.length / filteredTransactions.length) * 100).toFixed(1)}%</strong>`;
        }
        
        function searchInTransactions(searchTerm) {
            const matches = filteredTransactions.filter(t => 
                t.service.toLowerCase().includes(searchTerm.toLowerCase()) ||
                t.category.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            if (matches.length === 0) {
                return `üîç Nenhuma transa√ß√£o encontrada para <strong>"${searchTerm}"</strong>.`;
            }
            
            const total = matches.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const uniqueServices = new Set(matches.map(t => t.service));
            
            return `üîç <strong>Resultados para "${searchTerm}":</strong><br><br>
            ‚Ä¢ Transa√ß√µes encontradas: <strong>${matches.length}</strong><br>
            ‚Ä¢ Total gasto: <strong>R$ ${total.toLocaleString('pt-BR')}</strong><br>
            ‚Ä¢ Servi√ßos: <strong>${Array.from(uniqueServices).slice(0, 3).join(', ')}</strong>`;
        }
        
        function generateContextualResponse(question, stats) {
            // Resposta inteligente baseada no contexto da pergunta
            if (question.includes('?')) {
                return `ü§î <strong>Baseado na sua pergunta:</strong><br><br>
                Analisando os dados atuais (${stats.transactions} transa√ß√µes, R$ ${stats.totalBRL.toLocaleString('pt-BR')}), 
                posso ajudar com an√°lises espec√≠ficas. Tente perguntas como:<br><br>
                ‚Ä¢ "Qual categoria gasta mais?"<br>
                ‚Ä¢ "Como est√° a evolu√ß√£o mensal?"<br>
                ‚Ä¢ "Quais servi√ßos uso mais?"<br>
                ‚Ä¢ "Preciso economizar em alguma √°rea?"`;
            }
            
            return `üí° <strong>Posso ajudar com isso!</strong><br><br>
            Com base nos dados filtrados (${stats.transactions} transa√ß√µes), posso responder sobre:<br><br>
            üìä An√°lises financeiras e estat√≠sticas<br>
            üè¢ Informa√ß√µes sobre fornecedores<br>
            üìÖ Compara√ß√µes temporais<br>
            üîç Buscas espec√≠ficas<br>
            üí∞ Recomenda√ß√µes de economia<br><br>
            <strong>O que voc√™ gostaria de saber?</strong>`;
        }
        function calculateCurrentStats() {
            const totalBRL = filteredTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const aiTransactions = filteredTransactions.filter(t => t.category === 'IA');
            const aiPercentage = Math.round((aiTransactions.length / filteredTransactions.length) * 100);
            
            const categoryTotals = {};
            filteredTransactions.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseBRL(t.brl);
            });
            
            const topCategory = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)[0]?.[0] || 'N/A';
            
            return {
                transactions: filteredTransactions.length,
                totalBRL: totalBRL,
                avgTransaction: totalBRL / filteredTransactions.length,
                aiPercentage: aiPercentage,
                topCategory: topCategory,
                period: currentMonth === 'all' ? 'Maio-Julho 2025' : `${currentMonth.charAt(0).toUpperCase() + currentMonth.slice(1)} 2025`
            };
        }

        function findLargestTransaction() {
            return filteredTransactions.reduce((max, current) => 
                parseBRL(current.brl) > parseBRL(max.brl) ? current : max
            );
        }

        function getAIStats() {
            const aiTransactions = filteredTransactions.filter(t => t.category === 'IA');
            const total = aiTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const percentage = Math.round((aiTransactions.length / filteredTransactions.length) * 100);
            
            const serviceStats = {};
            aiTransactions.forEach(t => {
                serviceStats[t.service] = (serviceStats[t.service] || 0) + parseBRL(t.brl);
            });
            
            const topServices = Object.entries(serviceStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([service]) => service);
            
            return {
                total: total,
                transactions: aiTransactions.length,
                percentage: percentage,
                topServices: topServices
            };
        }

        function getTopCategory() {
            const categoryTotals = {};
            filteredTransactions.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseBRL(t.brl);
            });
            
            const [name, total] = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)[0] || ['N/A', 0];
            
            const transactions = filteredTransactions.filter(t => t.category === name).length;
            
            return { name, total, transactions };
        }

        function getMonthStats(month) {
            const monthTransactions = allTransactions.filter(t => t.month === month);
            const total = monthTransactions.reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const largest = monthTransactions.reduce((max, current) => 
                parseBRL(current.brl) > parseBRL(max.brl) ? current : max
            );
            
            const categoryTotals = {};
            monthTransactions.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseBRL(t.brl);
            });
            
            const topCategory = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)[0]?.[0] || 'N/A';
            
            return {
                transactions: monthTransactions.length,
                total: total,
                largest: largest,
                topCategory: topCategory
            };
        }

        function getMonthComparison() {
            const maio = allTransactions.filter(t => t.month === 'maio')
                .reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const junho = allTransactions.filter(t => t.month === 'junho')
                .reduce((sum, t) => sum + parseBRL(t.brl), 0);
            const julho = allTransactions.filter(t => t.month === 'julho')
                .reduce((sum, t) => sum + parseBRL(t.brl), 0);
            
            let trend = '';
            if (julho > junho && junho > maio) {
                trend = 'üìà Tend√™ncia crescente nos gastos.';
            } else if (julho < junho && junho < maio) {
                trend = 'üìâ Tend√™ncia decrescente nos gastos.';
            } else {
                trend = 'üìä Gastos vari√°veis entre os meses.';
            }
            
            return { maio, junho, julho, trend };
        }

        // Adicionar window para garantir escopo global
        window.toggleChat = toggleChat;
        window.sendMessage = sendMessage;
        window.sendSuggestedQuestion = sendSuggestedQuestion;
    </script>
</body>
</html>
