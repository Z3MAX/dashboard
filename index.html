<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Cart√£o Corporativo Technology</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 2.2em;
            color: #2c3e50;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .login-header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .form-group input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .login-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f5582);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
            white-space: nowrap;
        }

        .logout-btn:hover {
            background: #c0392b;
        }
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .file-upload {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .file-upload h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .upload-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .add-file-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-file-btn:hover {
            background: #219a52;
        }

        .process-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        .process-btn:hover {
            background: #2980b9;
        }

        .process-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        .files-container {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .file-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: border-color 0.3s ease;
        }

        .file-item.has-file {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .file-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-item-title {
            font-weight: bold;
            color: #2c3e50;
        }

        .remove-file-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .file-item-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            align-items: center;
        }

        .month-input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
        }

        .month-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .file-input {
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            background: white;
            width: 100%;
            cursor: pointer;
        }

        .file-status {
            font-size: 12px;
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric strong {
            color: #2c3e50;
        }

        .metric .value {
            color: #27ae60;
            font-weight: bold;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4em;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .transactions-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .filter-controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        select, input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }

        .total-section {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .total-section h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .total-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .total-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .total-item h4 {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .total-item .amount {
            font-size: 1.5em;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #e74c3c;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .monthly-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @media (max-width: 768px) {
            .login-container {
                margin: 20px;
                padding: 30px 20px;
            }
            
            .login-header h1 {
                font-size: 1.8em;
            }
            
            .file-item-content {
                grid-template-columns: 1fr;
            }
            
            .upload-controls {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <h1>üîê Acesso Restrito</h1>
                <p>Dashboard Cart√£o Corporativo Technology</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">üë§ Usu√°rio:</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">üîë Senha:</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">üöÄ Entrar</button>
                <div id="loginError" class="login-error hidden"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="mainDashboard" class="container hidden">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üè¢ Dashboard Cart√£o Corporativo Technology</h1>
                    <p>An√°lise Completa dos Gastos Corporativos - M√∫ltiplos Per√≠odos</p>
                </div>
                <button id="logoutBtn" class="logout-btn">üö™ Sair</button>
            </div>
        </div>
    </div>

        <div class="file-upload">
            <h3>üìÇ Carregar Arquivos Excel</h3>
            <p>Adicione quantos arquivos desejar e especifique o per√≠odo de cada um</p>
            
            <div class="upload-controls">
                <button id="addFileBtn" class="add-file-btn">
                    ‚ûï Adicionar Arquivo
                </button>
                <button id="processBtn" class="process-btn" disabled>
                    üìä Processar Dados
                </button>
                <button id="clearAllBtn" class="clear-btn">
                    üóëÔ∏è Limpar Tudo
                </button>
            </div>

            <div id="filesContainer" class="files-container">
                <!-- Arquivos ser√£o adicionados dinamicamente aqui -->
            </div>

            <div id="uploadStatus"></div>
        </div>

        <div id="dashboardContent" class="hidden">
            <div class="total-section">
                <h2>üìä Resumo Executivo</h2>
                <div class="total-grid">
                    <div class="total-item">
                        <h4>Total de Transa√ß√µes</h4>
                        <div class="amount" id="total-transactions">-</div>
                    </div>
                    <div class="total-item">
                        <h4>Total em USD</h4>
                        <div class="amount" id="total-usd">-</div>
                    </div>
                    <div class="total-item">
                        <h4>Total em BRL</h4>
                        <div class="amount" id="total-brl">-</div>
                    </div>
                    <div class="total-item">
                        <h4>Ticket M√©dio</h4>
                        <div class="amount" id="avg-ticket">-</div>
                    </div>
                </div>
            </div>

            <div id="monthlyCards" class="monthly-cards">
                <!-- Cards mensais ser√£o gerados dinamicamente -->
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>üí∞ Gastos por Per√≠odo (BRL)</h3>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>üè∑Ô∏è Gastos por Categoria</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>üìä Comparativo USD vs BRL</h3>
                    <div class="chart-container">
                        <canvas id="currencyChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>üìà Distribui√ß√£o de Transa√ß√µes</h3>
                    <div class="chart-container">
                        <canvas id="transactionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="filter-controls">
                <div class="filter-group">
                    <label><strong>Filtrar por:</strong></label>
                    <select id="monthFilter">
                        <option value="all">Todos os Per√≠odos</option>
                    </select>
                    <select id="categoryFilter">
                        <option value="all">Todas as Categorias</option>
                    </select>
                    <input type="text" id="searchFilter" placeholder="Buscar por movimenta√ß√£o...">
                </div>
            </div>

            <div class="transactions-table">
                <h3>üìã Detalhamento Completo das Transa√ß√µes</h3>
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>Per√≠odo</th>
                                <th>Profissional</th>
                                <th>Data</th>
                                <th>Movimenta√ß√£o</th>
                                <th>Categoria</th>
                                <th>Valor USD</th>
                                <th>Valor BRL</th>
                                <th>Relat√≥rio</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let data = null;
        let filteredData = [];
        let charts = {};
        let fileItems = [];
        let fileIdCounter = 0;
        let isLoggedIn = false;

        // Credenciais (em produ√ß√£o, use autentica√ß√£o adequada)
        const CREDENTIALS = {
            username: 'admin',
            password: 'int@789!'
        };

        // Inicializar aplica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            initializeEventListeners();
        });

        function initializeEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Dashboard
            document.getElementById('addFileBtn').addEventListener('click', addFileItem);
            document.getElementById('processBtn').addEventListener('click', processFiles);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllFiles);
        }

        function checkLoginStatus() {
            // Verificar se j√° est√° logado (usando sessionStorage)
            const loginStatus = sessionStorage.getItem('dashboardLogin');
            if (loginStatus === 'true') {
                showDashboard();
            } else {
                showLogin();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (username === CREDENTIALS.username && password === CREDENTIALS.password) {
                sessionStorage.setItem('dashboardLogin', 'true');
                showDashboard();
                clearLoginForm();
            } else {
                errorDiv.textContent = '‚ùå Usu√°rio ou senha incorretos!';
                errorDiv.classList.remove('hidden');
                
                // Limpar erro ap√≥s 3 segundos
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 3000);
                
                // Shake effect
                const loginContainer = document.querySelector('.login-container');
                loginContainer.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    loginContainer.style.animation = '';
                }, 500);
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('dashboardLogin');
            clearDashboardData();
            showLogin();
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainDashboard').classList.add('hidden');
            isLoggedIn = false;
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            isLoggedIn = true;
            
            // Adicionar um arquivo inicial se n√£o houver nenhum
            if (fileItems.length === 0) {
                addFileItem();
            }
        }

        function clearLoginForm() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        function clearDashboardData() {
            // Limpar dados do dashboard
            data = null;
            filteredData = [];
            fileItems = [];
            fileIdCounter = 0;
            
            // Limpar containers
            document.getElementById('filesContainer').innerHTML = '';
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('uploadStatus').innerHTML = '';
            
            // Destruir gr√°ficos
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }

        function addFileItem() {
            const fileId = `file_${fileIdCounter++}`;
            const filesContainer = document.getElementById('filesContainer');
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.id = fileId;
            
            fileItem.innerHTML = `
                <div class="file-item-header">
                    <div class="file-item-title">Arquivo ${fileIdCounter}</div>
                    <button class="remove-file-btn" onclick="removeFileItem('${fileId}')">‚ùå Remover</button>
                </div>
                <div class="file-item-content">
                    <div>
                        <label for="${fileId}_month">Nome/Per√≠odo:</label>
                        <input type="text" id="${fileId}_month" class="month-input" placeholder="Ex: Janeiro 2025, Q1 2025, etc." required>
                    </div>
                    <div>
                        <label for="${fileId}_file">Arquivo Excel:</label>
                        <input type="file" id="${fileId}_file" class="file-input" accept=".xlsx,.xls" required>
                        <div id="${fileId}_status" class="file-status"></div>
                    </div>
                </div>
            `;
            
            filesContainer.appendChild(fileItem);
            
            // Adicionar event listeners
            document.getElementById(`${fileId}_file`).addEventListener('change', function(e) {
                updateFileStatus(fileId, e.target.files[0]);
                checkFilesReady();
            });
            
            document.getElementById(`${fileId}_month`).addEventListener('input', checkFilesReady);
            
            fileItems.push(fileId);
            checkFilesReady();
        }

        function removeFileItem(fileId) {
            const fileItem = document.getElementById(fileId);
            fileItem.remove();
            fileItems = fileItems.filter(id => id !== fileId);
            checkFilesReady();
        }

        function clearAllFiles() {
            const filesContainer = document.getElementById('filesContainer');
            filesContainer.innerHTML = '';
            fileItems = [];
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('uploadStatus').innerHTML = '';
            checkFilesReady();
        }

        function updateFileStatus(fileId, file) {
            const statusDiv = document.getElementById(`${fileId}_status`);
            const fileItem = document.getElementById(fileId);
            
            if (file) {
                statusDiv.innerHTML = `<div class="status-success">‚úÖ ${file.name} selecionado</div>`;
                fileItem.classList.add('has-file');
            } else {
                statusDiv.innerHTML = '';
                fileItem.classList.remove('has-file');
            }
        }

        function checkFilesReady() {
            const processBtn = document.getElementById('processBtn');
            let allReady = fileItems.length > 0;
            
            fileItems.forEach(fileId => {
                const monthInput = document.getElementById(`${fileId}_month`);
                const fileInput = document.getElementById(`${fileId}_file`);
                
                if (!monthInput.value.trim() || !fileInput.files[0]) {
                    allReady = false;
                }
            });
            
            processBtn.disabled = !allReady;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        async function processFiles() {
            try {
                showStatus('üîÑ Processando arquivos...', 'loading');
                
                const allData = [];
                const monthlyTotals = {};
                
                for (const fileId of fileItems) {
                    const monthInput = document.getElementById(`${fileId}_month`);
                    const fileInput = document.getElementById(`${fileId}_file`);
                    
                    const monthName = monthInput.value.trim();
                    const file = fileInput.files[0];
                    
                    if (file && monthName) {
                        showStatus(`üîÑ Processando ${monthName}...`, 'loading');
                        const processedData = await processExcelFile(file, monthName);
                        allData.push(...processedData.transactions);
                        monthlyTotals[monthName] = processedData.totals;
                    }
                }
                
                const categorizedData = {};
                Object.keys(monthlyTotals).forEach(month => {
                    const monthTransactions = allData.filter(t => t.mes === month);
                    categorizedData[month] = categorizeData(monthTransactions);
                });
                
                data = {
                    allTransactions: allData,
                    monthlyTotals: monthlyTotals,
                    categorizedData: categorizedData
                };
                
                showStatus('‚úÖ Arquivos processados com sucesso!', 'success');
                document.getElementById('dashboardContent').classList.remove('hidden');
                initializeDashboard();
                
            } catch (error) {
                console.error('Erro ao processar arquivos:', error);
                showStatus(`‚ùå Erro ao processar arquivos: ${error.message}`, 'error');
            }
        }

        function processExcelFile(file, monthName) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        // Os headers est√£o na linha 2 (√≠ndice 2)
                        const headers = data[2];
                        
                        // Os dados come√ßam na linha 3 (√≠ndice 3)
                        const transactions = [];
                        let totalUSD = 0;
                        let totalBRL = 0;
                        
                        for (let i = 3; i < data.length; i++) {
                            const row = data[i];
                            if (!row || row.length === 0 || !row[0]) continue;
                            
                            const transaction = {
                                profissional: row[0],
                                data: row[1],
                                movimentacao: row[2],
                                valorUSD: row[3] || 0,
                                valorBRL: row[4] || 0,
                                relatorio: row[5] || '',
                                status: row[6] || '',
                                nfInvoice: row[7] || '',
                                mes: monthName
                            };
                            
                            transactions.push(transaction);
                            totalUSD += parseFloat(transaction.valorUSD) || 0;
                            totalBRL += parseFloat(transaction.valorBRL) || 0;
                        }
                        
                        resolve({
                            transactions,
                            totals: {
                                transacoes: transactions.length,
                                usd: totalUSD,
                                brl: totalBRL
                            }
                        });
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsBinaryString(file);
            });
        }

        function categorizeTransaction(movimentacao) {
            const mov = movimentacao.toUpperCase();
            if (mov.includes('OPENAI') || mov.includes('ANTHROPIC') || mov.includes('CLAUDE') || 
                mov.includes('SURFERSEO') || mov.includes('HUGGINGFACE') || mov.includes('MERLIN') || 
                mov.includes('PERPLEXITY') || mov.includes('CURSOR') || mov.includes('ZAPIER') || 
                mov.includes('N8N') || mov.includes('CREW AI') || mov.includes('DEEPL')) return 'AI/ML';
            if (mov.includes('MERCADOLIVRE') || mov.includes('MERCADOLIV')) return 'E-commerce';
            if (mov.includes('KABUM') || mov.includes('HUB*KABUM')) return 'Hardware';
            if (mov.includes('MIRO') || mov.includes('BOLT') || mov.includes('STACKBLITZ') || mov.includes('VUE')) return 'Dev Tools';
            if (mov.includes('CHECKR') || mov.includes('ABACUS')) return 'SaaS/Tools';
            if (mov.includes('GITHUB') || mov.includes('GIT')) return 'Code/Git';
            if (mov.includes('DIGITAL OCEAN') || mov.includes('DIGITALOCEAN')) return 'Cloud/Hosting';
            if (mov.includes('REGISTROBR') || mov.includes('ONLYDOMAINS')) return 'Dom√≠nios';
            if (mov.includes('AWS') || mov.includes('AMAZON')) return 'Cloud/AWS';
            return 'Outros';
        }

        function categorizeData(transactions) {
            const categorized = {};
            
            transactions.forEach(transaction => {
                const category = categorizeTransaction(transaction.movimentacao);
                
                if (!categorized[category]) {
                    categorized[category] = {
                        usd: 0,
                        brl: 0,
                        transacoes: 0
                    };
                }
                
                categorized[category].usd += parseFloat(transaction.valorUSD) || 0;
                categorized[category].brl += parseFloat(transaction.valorBRL) || 0;
                categorized[category].transacoes += 1;
            });
            
            return categorized;
        }

        function formatCurrency(value, currency = 'BRL') {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: currency
            }).format(value);
        }

        function initializeDashboard() {
            updateSummaryCards();
            createMonthlyCards();
            createCharts();
            populateFilters();
            populateTransactionsTable();
        }

        function updateSummaryCards() {
            const months = Object.keys(data.monthlyTotals);
            const totalTransactions = months.reduce((sum, month) => sum + data.monthlyTotals[month].transacoes, 0);
            const totalUSD = months.reduce((sum, month) => sum + data.monthlyTotals[month].usd, 0);
            const totalBRL = months.reduce((sum, month) => sum + data.monthlyTotals[month].brl, 0);
            const avgTicket = totalBRL / totalTransactions;

            document.getElementById('total-transactions').textContent = totalTransactions;
            document.getElementById('total-usd').textContent = formatCurrency(totalUSD, 'USD');
            document.getElementById('total-brl').textContent = formatCurrency(totalBRL);
            document.getElementById('avg-ticket').textContent = formatCurrency(avgTicket);
        }

        function createMonthlyCards() {
            const monthlyCardsContainer = document.getElementById('monthlyCards');
            monthlyCardsContainer.innerHTML = '';

            Object.keys(data.monthlyTotals).forEach((month, index) => {
                const totals = data.monthlyTotals[month];
                const card = document.createElement('div');
                card.className = 'card';
                
                card.innerHTML = `
                    <h3>üìÖ ${month}</h3>
                    <div class="metric">
                        <span><strong>Transa√ß√µes:</strong></span>
                        <span class="value">${totals.transacoes}</span>
                    </div>
                    <div class="metric">
                        <span><strong>Total USD:</strong></span>
                        <span class="value">${formatCurrency(totals.usd, 'USD')}</span>
                    </div>
                    <div class="metric">
                        <span><strong>Total BRL:</strong></span>
                        <span class="value">${formatCurrency(totals.brl)}</span>
                    </div>
                `;
                
                monthlyCardsContainer.appendChild(card);
            });
        }

        function createCharts() {
            createMonthlyChart();
            createCategoryChart();
            createCurrencyChart();
            createTransactionChart();
        }

        function createMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (charts.monthly) charts.monthly.destroy();
            
            const months = Object.keys(data.monthlyTotals);
            const brlData = months.map(month => data.monthlyTotals[month].brl);
            
            charts.monthly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Gastos em BRL',
                        data: brlData,
                        backgroundColor: months.map((_, i) => `hsl(${(i * 360 / months.length)}, 70%, 60%)`),
                        borderColor: months.map((_, i) => `hsl(${(i * 360 / months.length)}, 70%, 40%)`),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function createCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (charts.category) charts.category.destroy();
            
            const allCategories = new Set();
            Object.values(data.categorizedData).forEach(monthData => {
                Object.keys(monthData).forEach(cat => allCategories.add(cat));
            });
            
            const categories = Array.from(allCategories);
            const categoryTotals = categories.map(cat => {
                return Object.values(data.categorizedData).reduce((sum, monthData) => {
                    return sum + ((monthData[cat] || {}).brl || 0);
                }, 0);
            });

            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: categoryTotals,
                        backgroundColor: categories.map((_, i) => `hsl(${(i * 360 / categories.length)}, 70%, 60%)`)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createCurrencyChart() {
            const ctx = document.getElementById('currencyChart').getContext('2d');
            if (charts.currency) charts.currency.destroy();
            
            const months = Object.keys(data.monthlyTotals);
            
            charts.currency = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'USD',
                        data: months.map(month => data.monthlyTotals[month].usd),
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'BRL',
                        data: months.map(month => data.monthlyTotals[month].brl),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function createTransactionChart() {
            const ctx = document.getElementById('transactionChart').getContext('2d');
            if (charts.transaction) charts.transaction.destroy();
            
            const months = Object.keys(data.monthlyTotals);
            
            charts.transaction = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'N√∫mero de Transa√ß√µes',
                        data: months.map(month => data.monthlyTotals[month].transacoes),
                        backgroundColor: months.map((_, i) => `hsl(${(i * 360 / months.length + 180) % 360}, 70%, 60%)`),
                        borderColor: months.map((_, i) => `hsl(${(i * 360 / months.length + 180) % 360}, 70%, 40%)`),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function populateFilters() {
            const monthFilter = document.getElementById('monthFilter');
            monthFilter.innerHTML = '<option value="all">Todos os Per√≠odos</option>';
            
            Object.keys(data.monthlyTotals).forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            });

            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="all">Todas as Categorias</option>';
            
            const allCategories = new Set();
            Object.values(data.categorizedData).forEach(monthData => {
                Object.keys(monthData).forEach(cat => allCategories.add(cat));
            });
            
            Array.from(allCategories).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });

            // Event listeners para filtros
            document.getElementById('monthFilter').addEventListener('change', filterTransactions);
            document.getElementById('categoryFilter').addEventListener('change', filterTransactions);
            document.getElementById('searchFilter').addEventListener('input', filterTransactions);
        }

        function populateTransactionsTable() {
            filteredData = [...(data.allTransactions || [])];
            renderTransactionsTable();
        }

        function renderTransactionsTable() {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';

            filteredData.forEach(transaction => {
                const row = document.createElement('tr');
                const category = categorizeTransaction(transaction.movimentacao);
                
                row.innerHTML = `
                    <td>${transaction.mes}</td>
                    <td>${transaction.profissional}</td>
                    <td>${transaction.data}</td>
                    <td>${transaction.movimentacao}</td>
                    <td><span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8em;">${category}</span></td>
                    <td>${transaction.valorUSD ? formatCurrency(transaction.valorUSD, 'USD') : '-'}</td>
                    <td>${transaction.valorBRL ? formatCurrency(transaction.valorBRL) : '-'}</td>
                    <td>${transaction.relatorio || '-'}</td>
                    <td>${transaction.status || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterTransactions() {
            const monthFilter = document.getElementById('monthFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredData = (data.allTransactions || []).filter(transaction => {
                const matchMonth = monthFilter === 'all' || transaction.mes === monthFilter;
                const matchCategory = categoryFilter === 'all' || categorizeTransaction(transaction.movimentacao) === categoryFilter;
                const matchSearch = transaction.movimentacao.toLowerCase().includes(searchFilter);
                
                return matchMonth && matchCategory && matchSearch;
            });

            renderTransactionsTable();
        }

        // Adicionar um arquivo inicial quando o dashboard for mostrado
        // (removido daqui pois agora √© chamado em showDashboard())
    </script>
</body>
</html>
